<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Babysit Buddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="register-helper.js"></script>
    <script src="email-integration.js" type="text/javascript"></script>
<!--     <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-firestore.js"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#5D5CDE',
                            dark: '#7A79F1'
                        },
                        secondary: {
                            light: '#FFC107',
                            dark: '#FFD54F'
                        },
                        background: {
                            light: '#FFFFFF',
                            dark: '#181818'
                        },
                        card: {
                            light: '#F8F9FA',
                            dark: '#262626'
                        },
                        text: {
                            light: '#333333',
                            dark: '#E0E0E0'
                        }
                    }
                }
            }
        }

        // Set up dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            width: 100%;
            height: 2.5rem;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0.5rem;
            position: relative;
            font-weight: 500;
            border: 1px solid transparent;
        }
        
        .calendar-day:hover:not(.day-disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }

        .day-available {
            background-color: rgba(93, 92, 222, 0.15);
            color: #5D5CDE;
            border: 1px solid rgba(93, 92, 222, 0.3);
        }

        .dark .day-available {
            background-color: rgba(122, 121, 241, 0.15);
            color: #7A79F1;
            border: 1px solid rgba(122, 121, 241, 0.3);
        }

        .day-booked {
            background-color: rgba(255, 0, 0, 0.15);
            color: #FF4040;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .dark .day-booked {
            background-color: rgba(255, 77, 77, 0.15);
            color: #FF4D4D;
            border: 1px solid rgba(255, 77, 77, 0.3);
        }

        .day-disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dark .day-disabled {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .day-today {
            font-weight: 700;
            box-shadow: inset 0 0 0 2px #5D5CDE;
        }

        .dark .day-today {
            box-shadow: inset 0 0 0 2px #7A79F1;
        }

        .calendar-container {
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark .calendar-container {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .dark .calendar-header {
            color: #aaa;
        }

        .day-available::after {
            content: "";
            position: absolute;
            bottom: 3px;
            width: 6px;
            height: 6px;
            background-color: #5D5CDE;
            border-radius: 50%;
        }

        .dark .day-available::after {
            background-color: #7A79F1;
        }

        .day-booked::after {
            content: "";
            position: absolute;
            bottom: 3px;
            width: 6px;
            height: 6px;
            background-color: #FF4040;
            border-radius: 50%;
        }

        .dark .day-booked::after {
            background-color: #FF4D4D;
        }

        #calendar-grid, #sitter-calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }

        /* Subtle animation for transitions */
        .fade-transition {
            transition: all 0.3s ease;
        }

        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #5D5CDE;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        .dark .loader {
            border-color: #7A79F1;
            border-bottom-color: transparent;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Homepage styles */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            z-index: 0;
            opacity: 0.5;
        }
        
        .hero-image {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
            100% {
                transform: translateY(0px);
            }
        }
        
        .feature-card {
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .testimonial-card {
            transition: all 0.3s ease;
        }
        
        .testimonial-card:hover {
            transform: scale(1.03);
        }
        
        .step-card {
            position: relative;
        }
        
        .step-card::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -1rem;
            width: 2rem;
            height: 2px;
            background-color: #5D5CDE;
            display: none;
        }
        
        @media (min-width: 768px) {
            .step-card:not(:last-child)::after {
                display: block;
            }
        }
        
        .dark .step-card::after {
            background-color: #7A79F1;
        }

        /* Splitter styling */
        #splitter {
            position: relative;
            cursor: col-resize;
            transition: background-color 0.2s ease;
            margin: 0 10px;
        }

        #splitter:hover,
        #splitter:active {
            background-color: rgba(93, 92, 222, 0.5); /* Using primary color with opacity */
        }

        #splitter::before {
            content: '';
            position: absolute;
            left: -5px;
            right: -5px;
            top: 0;
            bottom: 0;
            cursor: col-resize;
        }

        #splitter .handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 5px;
            height: 40px;
            background-color: #5D5CDE;
            border-radius: 3px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .dark #splitter .handle {
            background-color: #7A79F1;
        }

        #splitter:hover .handle {
            opacity: 1;
        }

        /* Overlay styling for when splitter is being dragged */
        .resize-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            cursor: col-resize;
            user-select: none;
            background-color: transparent;
        }

        /* Animation for the handle when actively resizing */
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        #splitter.active .handle {
            animation: pulse 1s infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #splitter {
                width: 100%;
                height: 4px;
                margin: 10px 0;
            }
            
            #splitter .handle {
                width: 40px;
                height: 5px;
            }
            
            #splitter::before {
                left: 0;
                right: 0;
                top: -5px;
                bottom: -5px;
            }
        }

        .time-slot {
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .day-with-slots {
            position: relative;
        }

        .day-with-slots::after {
            content: "";
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 2px;
            background-color: currentColor;
            border-radius: 1px;
        }

        .time-slot-indicator {
            position: absolute;
            bottom: 3px;
            font-size: 6px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Tooltip for time slots */
        .calendar-day .time-slots-tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none;
            transition: visibility 0.1s, opacity 0.1s;
            opacity: 0;
        }

        .calendar-day:hover .time-slots-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .calendar-day .time-slots-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Time slot modal scrolling fix */
        #time-slots-container {
            max-height: 40vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* Custom scrollbar for time slots container */
        #time-slots-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #time-slots-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
        }
        
        #time-slots-container::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.5);
            border-radius: 3px;
        }
        
        .dark #time-slots-container::-webkit-scrollbar-thumb {
            background: rgba(122, 121, 241, 0.5);
        }
    
    /* Button click animation */
    .btn-click-effect {
        transition: all 0.15s ease;
    }
    
    .btn-click-effect:active {
        transform: scale(0.95);
        opacity: 0.75;
    }
    
    /* Add this class to all buttons in the modal */
    #time-slot-modal button {
        transition: all 0.15s ease;
    }
    
    #time-slot-modal button:active {
        transform: scale(0.95);
        opacity: 0.75;
    }

    </style>
</head>
<body class="min-h-screen bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark">
    <div id="app">
        <!-- Loading state -->
        <div id="loading" class="flex flex-col items-center justify-center h-screen">
            <span class="loader"></span>
            <p class="mt-4 text-lg">Loading Babysit Buddy...</p>
        </div>

        <!-- Homepage Container -->
        <div id="homepage-container" class="min-h-screen flex flex-col">
            <!-- Nav Bar -->
            <nav class="bg-white dark:bg-gray-900 shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 flex items-center">
                                <i class="fas fa-baby text-2xl text-primary-light dark:text-primary-dark mr-2"></i>
                                <span class="font-bold text-xl text-primary-light dark:text-primary-dark">Babysit Buddy</span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button id="show-login-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-light hover:bg-opacity-90 dark:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                                Login
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Hero Section -->
            <section class="relative overflow-hidden bg-white dark:bg-gray-900 py-16 sm:py-24">
                <!-- Decorative blobs -->
                <div class="blob bg-primary-light dark:bg-primary-dark w-72 h-72 top-0 -left-10 opacity-10"></div>
                <div class="blob bg-secondary-light dark:bg-secondary-dark w-96 h-96 bottom-0 right-0 opacity-10"></div>
                
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                        <div class="sm:text-center md:max-w-2xl md:mx-auto lg:col-span-6 lg:text-left">
                            <h1>
                                <span class="block text-sm font-semibold uppercase tracking-wide text-primary-light dark:text-primary-dark">Introducing</span>
                                <span class="mt-1 block text-4xl tracking-tight font-extrabold sm:text-5xl xl:text-6xl">
                                    <span class="block text-gray-900 dark:text-white">Babysitting Made</span>
                                    <span class="block text-primary-light dark:text-primary-dark">Simple & Safe</span>
                                </span>
                            </h1>
                            <p class="mt-3 text-base text-gray-500 dark:text-gray-400 sm:mt-5 sm:text-xl lg:text-lg xl:text-xl">
                                Connect parents with trusted teen babysitters in your neighborhood. Book with confidence, manage availability with ease, and build lasting connections.
                            </p>
                            <div class="mt-8 sm:max-w-lg sm:mx-auto sm:text-center lg:text-left">
                                <div class="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4">
                                    <button id="get-started-parent" class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-light hover:bg-opacity-90 dark:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                                        <i class="fas fa-user-friends mr-2"></i> I'm a Parent
                                    </button>
                                    <button id="get-started-sitter" class="inline-flex items-center justify-center px-5 py-3 border border-gray-300 dark:border-gray-700 text-base font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                                        <i class="fas fa-child mr-2"></i> I'm a Teen Sitter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-12 relative sm:max-w-lg sm:mx-auto lg:mt-0 lg:max-w-none lg:mx-0 lg:col-span-6 lg:flex lg:items-center">
                            <div class="relative mx-auto w-full rounded-lg shadow-lg lg:max-w-md">
                                <div class="relative block w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                                    <img class="w-full hero-image" src="https://images.unsplash.com/photo-1516627145497-ae6968895b74?ixlib=rb-4.0.3&auto=format&fit=crop&q=80&w=1740&h=1160" alt="Babysitting">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <button type="button" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-white bg-primary-light bg-opacity-90 dark:bg-primary-dark dark:bg-opacity-90 hover:bg-opacity-100 dark:hover:bg-opacity-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                                            <i class="fas fa-play mr-2"></i> See how it works
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- How It Works Section -->
            <section class="bg-gray-50 dark:bg-gray-800 py-16 sm:py-24">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center">
                        <h2 class="text-base font-semibold tracking-wide uppercase text-primary-light dark:text-primary-dark">How It Works</h2>
                        <p class="mt-1 text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl sm:tracking-tight">
                            Simple steps to find the perfect match
                        </p>
                    </div>

                    <div class="mt-12">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 text-center">For Parents</h3>
                        <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-primary-light text-white dark:bg-primary-dark mb-4">
                                    <span class="text-lg font-semibold">1</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Create an account</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Sign up and provide basic information about your family and babysitting needs.</p>
                            </div>
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-primary-light text-white dark:bg-primary-dark mb-4">
                                    <span class="text-lg font-semibold">2</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Connect with sitters</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Browse and connect with teen sitters in your area based on availability and experience.</p>
                            </div>
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-primary-light text-white dark:bg-primary-dark mb-4">
                                    <span class="text-lg font-semibold">3</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Book and enjoy</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Schedule bookings directly through the app and enjoy your time while the kids are in safe hands.</p>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6 mt-12 text-center">For Teen Sitters</h3>
                        <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-secondary-light text-white dark:bg-secondary-dark dark:text-gray-900 mb-4">
                                    <span class="text-lg font-semibold">1</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Create your profile</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Sign up as a sitter and showcase your experience, skills, and availability.</p>
                            </div>
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-secondary-light text-white dark:bg-secondary-dark dark:text-gray-900 mb-4">
                                    <span class="text-lg font-semibold">2</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Manage your calendar</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Mark your availability on the calendar so parents can see when you're free to babysit.</p>
                            </div>
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 step-card">
                                <div class="flex items-center justify-center w-12 h-12 rounded-md bg-secondary-light text-white dark:bg-secondary-dark dark:text-gray-900 mb-4">
                                    <span class="text-lg font-semibold">3</span>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Accept bookings</h4>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">Review and accept booking requests from parents and start building your babysitting career.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="py-16 sm:py-24">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center">
                        <h2 class="text-base font-semibold tracking-wide uppercase text-primary-light dark:text-primary-dark">Features</h2>
                        <p class="mt-1 text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl sm:tracking-tight">
                            Everything you need in one place
                        </p>
                        <p class="max-w-xl mt-5 mx-auto text-xl text-gray-500 dark:text-gray-400">
                            Our platform makes babysitting arrangements simple, safe, and stress-free.
                        </p>
                    </div>

                    <div class="mt-12 grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-calendar-alt text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Smart Calendar</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    View sitter availability at a glance and book dates that work for your schedule.
                                </p>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-user-shield text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Trusted Connections</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    Build relationships with sitters through our connection system before booking.
                                </p>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-bell text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Booking Management</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    Request, confirm, and manage all your babysitting bookings in one place.
                                </p>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-heart text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Favorites System</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    Save your favorite sitters for quick access and future bookings.
                                </p>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-search text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Smart Search</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    Find sitters quickly with our easy-to-use search functionality.
                                </p>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden feature-card">
                            <div class="p-6">
                                <div class="flex items-center justify-center h-12 w-12 rounded-md bg-primary-light dark:bg-primary-dark text-white">
                                    <i class="fas fa-moon text-xl"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">Dark Mode</h3>
                                <p class="mt-2 text-base text-gray-500 dark:text-gray-400">
                                    Enjoy a comfortable viewing experience day or night with automatic dark mode.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Testimonials Section -->
            <section class="bg-gray-50 dark:bg-gray-800 py-16 sm:py-24">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center">
                        <h2 class="text-base font-semibold tracking-wide uppercase text-primary-light dark:text-primary-dark">Testimonials</h2>
                        <p class="mt-1 text-3xl font-extrabold text-gray-900 dark:text-white sm:text-4xl sm:tracking-tight">
                            Hear from our happy users
                        </p>
                    </div>

                    <div class="mt-12 grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 testimonial-card">
                            <div class="flex items-center mb-4">
                                <div class="rounded-full bg-primary-light dark:bg-primary-dark h-10 w-10 flex items-center justify-center text-white">
                                    <span class="font-medium">JS</span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white">Jennifer Smith</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Parent of two</p>
                                </div>
                            </div>
                            <div class="text-yellow-400 flex mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300">
                                "Babysit Buddy has been a lifesaver! I found a wonderful sitter who my kids adore. The calendar system makes it so easy to book when I need childcare."
                            </p>
                        </div>

                        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 testimonial-card">
                            <div class="flex items-center mb-4">
                                <div class="rounded-full bg-secondary-light dark:bg-secondary-dark h-10 w-10 flex items-center justify-center text-white">
                                    <span class="font-medium">MC</span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white">Mike Chen</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Father of a toddler</p>
                                </div>
                            </div>
                            <div class="text-yellow-400 flex mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300">
                                "The connection system gives me peace of mind. I love knowing who's watching my son before they ever step foot in our home."
                            </p>
                        </div>

                        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 testimonial-card">
                            <div class="flex items-center mb-4">
                                <div class="rounded-full bg-primary-light dark:bg-primary-dark h-10 w-10 flex items-center justify-center text-white">
                                    <span class="font-medium">ET</span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white">Emma Taylor</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Teen Babysitter</p>
                                </div>
                            </div>
                            <div class="text-yellow-400 flex mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-300">
                                "As a busy student, I love how easy it is to manage my babysitting schedule. I've connected with amazing families and built my own small business!"
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CTA Section -->
            <section class="relative bg-primary-light dark:bg-primary-dark py-16 sm:py-24">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="relative rounded-2xl overflow-hidden">
                        <div class="relative z-10 px-4 sm:px-6 lg:px-8 py-12 md:py-20">
                            <div class="text-center">
                                <h2 class="text-3xl font-extrabold text-white sm:text-4xl">
                                    Ready to get started?
                                </h2>
                                <p class="mt-4 text-xl text-indigo-100">
                                    Join our community of parents and teen sitters today!
                                </p>
                                <div class="mt-8 flex justify-center">
                                    <div class="inline-flex rounded-md shadow">
                                        <button id="final-signup-btn" class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-primary-light bg-white hover:bg-gray-50 dark:text-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-primary-light dark:focus:ring-offset-primary-dark focus:ring-white">
                                            Sign up now
                                        </button>
                                    </div>
                                    <div class="ml-3 inline-flex">
                                        <button id="final-login-btn" class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-dark bg-opacity-60 hover:bg-opacity-70 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-primary-light dark:focus:ring-offset-primary-dark focus:ring-white">
                                            Log in
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="bg-white dark:bg-gray-900 pt-12 pb-8">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="xl:grid xl:grid-cols-3 xl:gap-8">
                        <div class="space-y-8 xl:col-span-1">
                            <div class="flex items-center">
                                <i class="fas fa-baby text-2xl text-primary-light dark:text-primary-dark mr-2"></i>
                                <span class="font-bold text-xl text-primary-light dark:text-primary-dark">Babysit Buddy</span>
                            </div>
                            <p class="text-gray-500 dark:text-gray-400 text-base">
                                Making babysitting simple, safe, and stress-free for parents and teen sitters.
                            </p>
                        </div>
                        <div class="mt-12 grid grid-cols-2 gap-8 xl:mt-0 xl:col-span-2">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Quick Links</h3>
                                <ul class="mt-4 space-y-4">
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">How it works</a></li>
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Features</a></li>
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Testimonials</a></li>
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Sign up</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Resources</h3>
                                <ul class="mt-4 space-y-4">
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Help Center</a></li>
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Privacy Policy</a></li>
                                    <li><a href="#" class="text-base text-gray-500 dark:text-gray-400 hover:text-primary-light dark:hover:text-primary-dark">Terms of Service</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-12 border-t border-gray-200 dark:border-gray-700 pt-8">
                        <p class="text-base text-gray-400 xl:text-center">
                            &copy; 2023 Babysit Buddy. All rights reserved.
                        </p>
                    </div>
                </div>
            </footer>
        </div>

        <!-- Auth Popup -->
        <div id="auth-popup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="w-full max-w-md p-6 bg-card-light dark:bg-card-dark rounded-lg shadow-lg slide-in">
                <div class="flex justify-end mb-4">
                    <button id="close-auth-popup" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex justify-center mb-6">
                    <h1 class="text-3xl font-bold text-primary-light dark:text-primary-dark">
                        <i class="fas fa-baby"></i> Babysit Buddy
                    </h1>
                </div>
                
                <!-- Auth Tabs -->
                <div class="flex mb-6 border-b border-gray-300 dark:border-gray-700">
                    <button id="login-tab" class="py-2 px-4 font-medium text-primary-light dark:text-primary-dark border-b-2 border-primary-light dark:border-primary-dark">Login</button>
                    <button id="register-tab" class="py-2 px-4 font-medium text-gray-500 dark:text-gray-400">Register</button>
                </div>
                
                <!-- Login Form -->
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="login-email" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="login-password" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700" required>
                        </div>
                        <div>
                            <button type="submit" class="w-full py-2 px-4 bg-primary-light hover:bg-opacity-90 text-white rounded-md transition-colors dark:bg-primary-dark">
                                Login
                            </button>
                        </div>
                        <div id="login-error" class="text-red-500 text-sm hidden"></div>
                    </form>
                
                <!-- Register Form -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label for="reg-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="reg-email" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700" required>
                    </div>
                    <div>
                        <label for="reg-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="reg-password" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700" required>
                    </div>
                    <div>
                        <label for="reg-name" class="block text-sm font-medium mb-1">Full Name</label>
                        <input type="text" id="reg-name" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">I am a:</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="user-type" value="parent" class="mr-2" checked>
                                <span>Parent</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="user-type" value="sitter" class="mr-2">
                                <span>Teen Sitter</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Parent-specific fields -->
                    <div id="parent-fields">
                        <label for="kids-ages" class="block text-sm font-medium mb-1">Kids' Ages (separated by commas)</label>
                        <input type="text" id="kids-ages" placeholder="e.g., 3, 5, 7" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700">
                    </div>
                    
                    <!-- Sitter-specific fields -->
                    <div id="sitter-fields" class="hidden">
                        <div>
                            <label for="sitter-age" class="block text-sm font-medium mb-1">Your Age</label>
                            <input type="number" id="sitter-age" min="13" max="19" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700">
                        </div>
                        <div class="mt-4">
                            <label for="sitter-experience" class="block text-sm font-medium mb-1">Years of Experience</label>
                            <input type="number" id="sitter-experience" min="0" max="5" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark dark:bg-gray-800 dark:border-gray-700">
                        </div>
                    </div>
                    
                    <div>
                        <button type="submit" class="w-full py-2 px-4 bg-primary-light hover:bg-opacity-90 text-white rounded-md transition-colors dark:bg-primary-dark">
                            Register
                        </button>
                    </div>
                    <div id="register-error" class="text-red-500 text-sm hidden"></div>
                </form>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard-container" class="hidden">
            <!-- App Header -->
            <header class="bg-white dark:bg-gray-900 shadow">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-xl md:text-2xl font-bold text-primary-light dark:text-primary-dark">
                        <i class="fas fa-baby"></i> Babysit Buddy
                    </h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-name" class="hidden md:inline-block"></span>
                        <button id="logout-btn" class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </header>

            <!-- Parent Dashboard -->
            <div id="parent-dashboard" class="container mx-auto px-4 py-6 hidden">
                <div class="flex" id="resizable-container">
                    <!-- Left Sidebar - Booking System -->
                    <div class="flex-1 min-w-[300px] pr-4" id="calendar-column">
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-calendar-alt mr-2"></i>Find Available Sitters
                            </h2>
                            
                            <!-- Search and Filter -->
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="flex-grow">
                                        <input type="text" id="sitter-search" placeholder="Search by name..." class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                                    </div>
                                    <div>
                                        <select id="month-selector" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                                            <!-- Will be populated by JS -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add time filter controls -->
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="flex-grow">
                                        <input type="text" id="sitter-search" placeholder="Search by sitter name" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                                    </div>
                                    
                                    <!-- Add time filter controls -->
                                    <div class="flex-grow md:flex-grow-0 flex gap-2 items-center">
                                        <div class="time-filter">
                                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">From</label>
                                            <input type="time" id="time-filter-start" class="w-full px-2 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                        <div class="time-filter">
                                            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">To</label>
                                            <input type="time" id="time-filter-end" class="w-full px-2 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                        <button id="apply-time-filter" class="mt-auto px-3 py-2 bg-primary-light hover:bg-opacity-90 text-white rounded-md transition-colors dark:bg-primary-dark">
                                            Filter
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Calendar -->
                            <div class="mb-6">
                                <div id="calendar-header" class="grid grid-cols-7 gap-1 mb-2 text-center font-medium">
                                    <div>Sun</div>
                                    <div>Mon</div>
                                    <div>Tue</div>
                                    <div>Wed</div>
                                    <div>Thu</div>
                                    <div>Fri</div>
                                    <div>Sat</div>
                                </div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be generated here -->
                                </div>
                            </div>
                            
                            <!-- Available Sitters List -->
                            <div id="available-sitters" class="space-y-4">
                                <h3 class="text-lg font-medium">Select a date to see available sitters</h3>
                                <div id="sitters-list" class="space-y-3">
                                    <!-- Sitters will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resizable Splitter -->
                    <div id="splitter" class="w-1 bg-gray-300 dark:bg-gray-700 cursor-col-resize hover:bg-primary-light dark:hover:bg-primary-dark flex items-center justify-center">
                        <div class="h-16 flex flex-col space-y-1 justify-center">
                            <div class="w-1 h-8 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                            <div class="w-1 h-8 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                        </div>
                    </div>
                    
                    <!-- Right Sidebar - Bookings & Favorites -->
                    <div class="w-[400px] pl-4" id="widgets-column">
                        <!-- Upcoming Bookings -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-calendar-check mr-2"></i>Upcoming Bookings
                            </h2>
                            <div id="upcoming-bookings" class="space-y-3">
                                <!-- Upcoming bookings will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No upcoming bookings</p>
                            </div>
                        </div>
                        
                        <!-- My Favorite Sitters -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-heart mr-2"></i>My Favorite Sitters
                            </h2>
                            <div id="favorite-sitters" class="space-y-3">
                                <!-- Favorite sitters will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No favorite sitters yet</p>
                            </div>
                        </div>
                        
                        <!-- Find and Connect with Sitters -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mt-4">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-search mr-2"></i>Find Sitters
                            </h2>
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row gap-3">
                                    <div class="flex-grow">
                                        <input type="text" id="sitter-name-search" placeholder="Search sitters by name..." class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                                    </div>
                                    <div>
                                        <button id="find-sitters-btn" class="w-full px-3 py-2 text-base bg-primary-light hover:bg-opacity-90 text-white rounded-md transition-colors dark:bg-primary-dark">
                                            Search
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="sitter-search-results" class="space-y-3">
                                <!-- Sitters search results will appear here -->
                                <p class="text-gray-500 dark:text-gray-400">Search for sitters by name</p>
                            </div>
                        </div>
                        
                        <!-- My Connected Sitters -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mt-4">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-link mr-2"></i>My Connected Sitters
                            </h2>
                            <div id="connected-sitters" class="space-y-3">
                                <!-- Connected sitters will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No connected sitters yet</p>
                            </div>
                        </div>
                        
                        <!-- Pending Connection Requests -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mt-4">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-clock mr-2"></i>Pending Requests
                            </h2>
                            <div id="pending-connections" class="space-y-3">
                                <!-- Pending connection requests will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No pending connection requests</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teen Sitter Dashboard -->
            <div id="sitter-dashboard" class="container mx-auto px-4 py-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Left Section - Availability Calendar -->
                    <div class="md:col-span-2">
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-calendar-alt mr-2"></i>Manage Your Availability
                            </h2>
                            <p class="mb-4 text-sm">Click on dates to mark yourself as available. Click again to remove availability.</p>
                            
                            <div class="mb-4">
                                <select id="sitter-month-selector" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                                    <!-- Will be populated by JS -->
                                </select>
                            </div>
                            
                            <!-- Sitter Calendar -->
                            <div class="calendar-container">
                                <div id="sitter-calendar-grid" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be generated here -->
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 text-sm">
                                <div class="flex items-center">
                                    <span class="inline-block w-4 h-4 mr-2 bg-blue-200 dark:bg-blue-900 rounded-sm"></span>
                                    <span>Available</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="inline-block w-4 h-4 mr-2 bg-red-200 dark:bg-red-900 rounded-sm"></span>
                                    <span>Booked</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Requests Section for Sitters -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-user-plus mr-2"></i>Connection Requests
                            </h2>
                            <div id="sitter-connection-requests" class="space-y-3">
                                <!-- Connection requests will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No pending connection requests</p>
                            </div>
                        </div>
                        
                        <!-- Connected Parents -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-link mr-2"></i>Connected Parents
                            </h2>
                            <div id="connected-parents" class="space-y-3">
                                <!-- Connected parents will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No connected parents yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Section - Booking Requests and Confirmed Bookings -->
                    <div class="md:col-span-1">
                        <!-- Booking Requests -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4 mb-6">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-bell mr-2"></i>Booking Requests
                            </h2>
                            <div id="booking-requests" class="space-y-3">
                                <!-- Booking requests will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No pending requests</p>
                            </div>
                        </div>
                        
                        <!-- Confirmed Bookings -->
                        <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-md p-4">
                            <h2 class="text-xl font-semibold mb-4">
                                <i class="fas fa-check-circle mr-2"></i>Confirmed Bookings
                            </h2>
                            <div id="confirmed-bookings" class="space-y-3">
                                <!-- Confirmed bookings will be listed here -->
                                <p class="text-gray-500 dark:text-gray-400">No confirmed bookings</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add confirmation popup for cancellations -->
        <div id="confirmation-popup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
            <div class="w-full max-w-md p-6 bg-card-light dark:bg-card-dark rounded-lg shadow-lg slide-in">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-medium" id="confirmation-title">Confirm Action</h3>
                    <p class="mt-2 text-gray-600 dark:text-gray-300" id="confirmation-message">Are you sure you want to proceed?</p>
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                        Yes, Cancel Booking
                    </button>
                    <button id="cancel-action-btn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">
                        No, Keep it
                    </button>
                </div>
            </div>
        </div>

        <!-- Add notification area for cancellations -->
        <div id="notification-area" class="fixed top-5 right-5 z-40 w-80 max-w-full hidden">
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg slide-in">
                <div class="flex">
                    <div class="py-1"><svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/></svg></div>
                    <div>
                        <p id="notification-message" class="font-bold">Booking Cancelled!</p>
                        <p id="notification-details" class="text-sm"></p>
                        <button id="dismiss-notification" class="mt-2 px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Dismiss</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Slot Selection Modal -->
        <div id="time-slot-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
            <div class="w-full max-w-md p-6 bg-card-light dark:bg-card-dark rounded-lg shadow-lg slide-in">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-medium" id="time-slot-modal-date">Set Available Times</h3>
                    <button id="close-time-slot-modal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Add time slots when you're available to babysit on this day.</p>
                </div>

                <div id="time-slots-container" class="space-y-3 mb-4">
                    <!-- Time slots will be added here -->
                </div>

                <div class="flex justify-between items-center mb-4">
                    <button id="add-time-slot-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-light hover:bg-opacity-90 dark:bg-primary-dark">
                        <i class="fas fa-plus mr-2"></i> Add Time Slot
                    </button>
                    <button id="save-time-slots-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600">
                        <i class="fas fa-save mr-2"></i> Save
                    </button>
                </div>
                
                <!-- Time slot template (hidden, will be cloned by JS) -->
                <div id="time-slot-template" class="hidden">
                    <div class="time-slot flex items-center space-x-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <div class="grow grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Start Time</label>
                                <input type="time" class="slot-start-time w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-700 dark:border-gray-600">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">End Time</label>
                                <input type="time" class="slot-end-time w-full px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-700 dark:border-gray-600">
                            </div>
                        </div>
                        <div class="flex items-end pb-1">
                            <button class="remove-time-slot-btn p-1 text-red-500 hover:text-red-700 dark:hover:text-red-400">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Add this right before the closing </div> of the app container -->

<!-- Booking Time Slot Selection Modal -->
<div id="booking-time-slot-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div class="w-full max-w-md p-6 bg-card-light dark:bg-card-dark rounded-lg shadow-lg slide-in">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-medium" id="booking-modal-date">Book Available Time</h3>
            <button id="close-booking-modal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-300" id="booking-sitter-info">Select an available time slot:</p>
        </div>

        <div id="booking-time-slots" class="space-y-3 mb-4 max-h-40 overflow-y-auto">
            <!-- Available time slots will appear here -->
            <p class="text-gray-500 dark:text-gray-400 text-center">No available time slots</p>
        </div>

        <div class="mb-4">
            <label for="booking-notes" class="block text-sm font-medium mb-1">Notes for sitter</label>
            <textarea id="booking-notes" rows="3" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700" 
                placeholder="Add any important information such as allergies, special needs, or specific instructions..."></textarea>
        </div>

        <div class="flex justify-end">
            <button id="confirm-booking-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-check mr-2"></i> Confirm Booking
            </button>
        </div>
    </div>
</div>


    </div>
    
    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        // Make sure these imports are present in your Firebase imports section
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            query, 
            where, 
            addDoc,
            updateDoc,
            deleteDoc,
            arrayUnion,
            arrayRemove,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Import email functions
        import { 
            sendAccountCreationEmail, 
            sendNewBookingRequestEmail,
            sendBookingConfirmationEmail,
            sendBookingCancellationEmail,
            notifySitterOfBookingRequest,
            notifyParentOfAcceptedBooking,
            notifyParentOfDeclinedBooking,
            notifySitterOfCancelledBooking,
            notifyParentOfCancelledBooking,
            notifyOfConnectionRequest,
            notifyOfAcceptedConnection
        } from "./mailgun.js";
    
        // Initialize Firebase with configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDblMgFPHey2MhILxFQCTVvpHU7Oov79Bs",
            authDomain: "babysitbuddy-cdeb4.firebaseapp.com",
            projectId: "babysitbuddy-cdeb4",
            storageBucket: "babysitbuddy-cdeb4.firebasestorage.app",
            messagingSenderId: "747303057907",
            appId: "1:747303057907:web:e47cc79d964a7dea917a86",
            measurementId: "G-LB7L1G837Y"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const parentDashboard = document.getElementById('parent-dashboard');
        const sitterDashboard = document.getElementById('sitter-dashboard');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const parentFields = document.getElementById('parent-fields');
        const sitterFields = document.getElementById('sitter-fields');
        const userNameDisplay = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const monthSelector = document.getElementById('month-selector');
        const sitterMonthSelector = document.getElementById('sitter-month-selector');

        // Current user data
        let currentUser = null;
        let userProfile = null;
        let selectedDate = null;
        
        // Switch between login and register tabs
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('text-primary-light', 'dark:text-primary-dark', 'border-b-2', 'border-primary-light', 'dark:border-primary-dark');
            loginTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            registerTab.classList.add('text-gray-500', 'dark:text-gray-400');
            registerTab.classList.remove('text-primary-light', 'dark:text-primary-dark', 'border-b-2', 'border-primary-light', 'dark:border-primary-dark');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        });
        
        registerTab.addEventListener('click', () => {
            registerTab.classList.add('text-primary-light', 'dark:text-primary-dark', 'border-b-2', 'border-primary-light', 'dark:border-primary-dark');
            registerTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            loginTab.classList.add('text-gray-500', 'dark:text-gray-400');
            loginTab.classList.remove('text-primary-light', 'dark:text-primary-dark', 'border-b-2', 'border-primary-light', 'dark:border-primary-dark');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });
        
        // Toggle user type fields
        const userTypeRadios = document.querySelectorAll('input[name="user-type"]');
        userTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'parent') {
                    parentFields.classList.remove('hidden');
                    sitterFields.classList.add('hidden');
                } else {
                    parentFields.classList.add('hidden');
                    sitterFields.classList.remove('hidden');
                }
            });
        });
        
        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state listener will handle redirection
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = `Login failed: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        });
        
        // Register form submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registerError.classList.add('hidden');
            
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const userType = document.querySelector('input[name="user-type"]:checked').value;
            
            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user profile based on type
                let profileData = {
                    userId: user.uid,
                    email: email,
                    name: name,
                    userType: userType,
                    createdAt: serverTimestamp(),
                    connections: [], // Add connections array
                    connectionRequests: [] // Add connection requests array
                };
                
                if (userType === 'parent') {
                    const kidsAges = document.getElementById('kids-ages').value;
                    profileData.kidsAges = kidsAges.split(',').map(age => age.trim()).filter(age => age);
                    profileData.favoriteSitters = [];
                } else {
                    const age = document.getElementById('sitter-age').value;
                    const experience = document.getElementById('sitter-experience').value;
                    profileData.age = parseInt(age);
                    profileData.experience = parseInt(experience);
                    profileData.availability = [];
                }
                
                // Save profile to Firestore
                await setDoc(doc(db, "users", user.uid), profileData);
                
                // Send welcome email
                try {
                    const result = await sendAccountCreationEmail(user.email, user.name);
                    if (result.success) {
                        console.log("Email sent successfully");
                    } else {
                        console.error("Failed to send email:", result.message);
                    }
                } catch (emailError) {
                    console.error("Error sending welcome email:", emailError);
                    // Don't block registration if email fails
                }
                
                // Auth state listener will handle redirection
            } catch (error) {
                console.error("Registration error:", error);
                registerError.textContent = `Registration failed: ${error.message}`;
                registerError.classList.remove('hidden');
            }
        });
        
        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Auth state listener will handle redirection
            } catch (error) {
                console.error("Logout error:", error);
                alert("Failed to log out");
            }
        });
        
        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            // Hide loading screen
            loadingEl.classList.add('hidden');
            
            if (user) {
                // User is signed in
                currentUser = user;
                
                try {
                    // Get user profile
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                        
                        // Display user name
                        userNameDisplay.textContent = userProfile.name;
                        userNameDisplay.classList.remove('hidden');
                        
                        // Show appropriate dashboard
                        authContainer.classList.add('hidden');
                        dashboardContainer.classList.remove('hidden');
                        
                        if (userProfile.userType === 'parent') {
                            parentDashboard.classList.remove('hidden');
                            sitterDashboard.classList.add('hidden');
                            setupParentDashboard();
                        } else {
                            sitterDashboard.classList.remove('hidden');
                            parentDashboard.classList.add('hidden');
                            setupSitterDashboard();
                        }
                    } else {
                        console.error("User profile not found");
                        authContainer.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    authContainer.classList.remove('hidden');
                }
            } else {
                // User is signed out
                currentUser = null;
                userProfile = null;
                
                // Show auth container
                authContainer.classList.remove('hidden');
                dashboardContainer.classList.add('hidden');
                parentDashboard.classList.add('hidden');
                sitterDashboard.classList.add('hidden');
                
                // Reset forms
                loginForm.reset();
                registerForm.reset();
            }
        });
        
        // Calendar utility functions
        function generateMonthOptions(selector) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Generate options for the next 6 months
            for (let i = 0; i < 6; i++) {
                const month = (currentMonth + i) % 12;
                const year = currentYear + Math.floor((currentMonth + i) / 12);
                const date = new Date(year, month, 1);
                
                const option = document.createElement('option');
                option.value = `${year}-${month + 1}`;
                option.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                selector.appendChild(option);
            }
        }
        
        function generateCalendar(calendarGrid, year, month, clickHandler, availableDates = [], bookedDates = []) {
            // Clear existing calendar
            calendarGrid.innerHTML = '';
            
            const date = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0).getDate();
            const firstDayIndex = date.getDay();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'day-disabled');
                calendarGrid.appendChild(emptyDay);
            }
            
            // Get current date for disabling past dates and highlighting today
            const currentDate = new Date();
            const today = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
            const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            
            // Add cells for each day of the month
            for (let day = 1; day <= lastDay; day++) {
                // FIX: Use consistent date creation to avoid timezone issues
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const dayDate = new Date(year, month - 1, day); // Correctly create local date
                
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day', 'rounded-md');
                dayEl.textContent = day;
                dayEl.dataset.date = dateStr;
                
                // Highlight today's date
                if (dateStr === todayStr) {
                    dayEl.classList.add('day-today');
                }
                
                // Disable past dates
                if (dayDate < today) {
                    dayEl.classList.add('day-disabled');
                } else {
                    // Check if date is available
                    if (availableDates.includes(dateStr)) {
                        dayEl.classList.add('day-available');
                    }
                    
                    // Check if date is booked
                    if (bookedDates.includes(dateStr)) {
                        dayEl.classList.add('day-booked');
                    }
                    
                    // Add click handler
                    dayEl.addEventListener('click', () => clickHandler(dateStr, dayEl));
                }
                
                calendarGrid.appendChild(dayEl);
            }
        }
        
        // Parent Dashboard Setup
        async function setupParentDashboard() {
            // Initialize month selector and calendar
            generateMonthOptions(monthSelector);
            
            // Fix the calendar header duplication issue
            const calendarParent = document.getElementById('calendar-grid').parentNode;
            const oldHeaders = calendarParent.querySelectorAll('.calendar-header');
            
            // Remove any existing calendar headers (except the first one)
            if (oldHeaders.length > 1) {
                for (let i = 1; i < oldHeaders.length; i++) {
                    oldHeaders[i].remove();
                }
            }
            
            document.getElementById('calendar-header').classList.add('calendar-header');
            const calendarContainer = document.createElement('div');
            calendarContainer.classList.add('calendar-container');
            
            // Remove the calendar grid from its parent
            const calendarGrid = document.getElementById('calendar-grid');
            if (calendarGrid.parentNode) {
                calendarGrid.parentNode.removeChild(calendarGrid);
            }
            
            // Add the calendar grid to the new container
            calendarContainer.appendChild(document.getElementById('calendar-header'));
            calendarContainer.appendChild(calendarGrid);
            
            // Add the container to the parent
            calendarParent.appendChild(calendarContainer);
            
            // Handle month selection change
            monthSelector.addEventListener('change', () => {
                const [year, month] = monthSelector.value.split('-').map(Number);
                generateParentCalendar(year, month);
            });
            
            // Initial calendar generation
            const initialDate = monthSelector.value.split('-').map(Number);
            generateParentCalendar(initialDate[0], initialDate[1]);
            
            // Load upcoming bookings
            loadUpcomingBookings();
            
            // Load favorite sitters
            loadFavoriteSitters();
            
            // Load connected sitters
            loadConnectedSitters();
            
            // Load pending connection requests
            loadPendingConnections();
            
            // Setup search functionality
            const sitterSearch = document.getElementById('sitter-search');
            sitterSearch.addEventListener('input', () => {
                if (selectedDate) {
                    loadAvailableSitters(selectedDate);
                }
            });
            
            // Setup find sitters functionality
            const findSittersBtn = document.getElementById('find-sitters-btn');
            findSittersBtn.addEventListener('click', () => {
                findSitters();
            });
            
            // Also enable pressing Enter key to search
            const sitterNameSearch = document.getElementById('sitter-name-search');
            sitterNameSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    findSitters();
                }
            });

            // Add resizable functionality
            setupResizableSplitter();

            // Setup time filter functionality
            const applyFilterBtn = document.getElementById('apply-time-filter');
            applyFilterBtn.addEventListener('click', () => {
                const [year, month] = monthSelector.value.split('-').map(Number);
                generateParentCalendar(year, month);
                if (selectedDate) {
                    loadAvailableSitters(selectedDate);
                }
            });

            // Initialize booking modal
            setupBookingModal();

            // Add this code at the bottom of your setupParentDashboard function
            // Make sure event handler for booking button is set up correctly
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('book-btn')) {
                    const sitterId = e.target.dataset.sitterId;
                    const sitters = document.querySelectorAll('.book-btn');
                    for (let i = 0; i < sitters.length; i++) {
                        if (sitters[i].dataset.sitterId === sitterId) {
                            const sitterData = availableSittersCache.find(s => s.id === sitterId);
                            if (sitterData) {
                                showBookingModal(sitterData, selectedDate);
                                break;
                            }
                        }
                    }
                }
            });

            // Initialize global cache for available sitters
            let availableSittersCache = [];

            // Update the loadAvailableSitters function to cache sitter data
            const originalLoadAvailableSitters = loadAvailableSitters;
            loadAvailableSitters = async function(date) {
                const result = await originalLoadAvailableSitters(date);
                // Cache is updated in the function
                return result;
            }
        }

        // Replace the generateParentCalendar function

async function generateParentCalendar(year, month) {
    const calendarGrid = document.getElementById('calendar-grid');
    
    // Get any active time filters
    const startTimeFilter = document.getElementById('time-filter-start').value;
    const endTimeFilter = document.getElementById('time-filter-end').value;
    
    try {
        // Get available dates from connected sitters for this month
        const availableDates = [];
        const availableTimeSlots = {}; // Store time slots for each available date
        
        // Get parent's connections
        const connections = userProfile.connections || [];
        
        if (connections.length > 0) {
            // Query only connected sitters
            for (const sitterId of connections) {
                const sitterDoc = await getDoc(doc(db, "users", sitterId));
                if (sitterDoc.exists()) {
                    const sitter = sitterDoc.data();
                    if (sitter.availability) {
                        // Filter dates for current month
                        const monthDates = sitter.availability.filter(date => {
                            const dateParts = date.split('-').map(Number);
                            return dateParts[0] === year && dateParts[1] === month;
                        });
                        
                        // For each available date, check the time slots
                        for (const date of monthDates) {
                            // Get time slots for this date
                            const timeSlots = sitter.timeSlots && sitter.timeSlots[date] ? sitter.timeSlots[date] : [];
                            
                            // If using time filter, only include dates with slots in the filtered time range
                            if (startTimeFilter && endTimeFilter && timeSlots.length > 0) {
                                const hasSlotInRange = timeSlots.some(slot => {
                                    return isTimeSlotInRange(slot.start, slot.end, startTimeFilter, endTimeFilter);
                                });
                                
                                if (hasSlotInRange) {
                                    if (!availableDates.includes(date)) {
                                        availableDates.push(date);
                                    }
                                    
                                    // Store time slots for this date
                                    if (!availableTimeSlots[date]) {
                                        availableTimeSlots[date] = [];
                                    }
                                    
                                    // Add sitter info to time slots
                                    availableTimeSlots[date].push({
                                        sitterId: sitterId,
                                        sitterName: sitter.name,
                                        timeSlots: timeSlots.filter(slot => 
                                            isTimeSlotInRange(slot.start, slot.end, startTimeFilter, endTimeFilter)
                                        )
                                    });
                                }
                            } else {
                                // If no time filter, include all available dates
                                if (!availableDates.includes(date)) {
                                    availableDates.push(date);
                                }
                                
                                // Store time slots for this date
                                if (!availableTimeSlots[date]) {
                                    availableTimeSlots[date] = [];
                                }
                                
                                // Add sitter info to time slots
                                availableTimeSlots[date].push({
                                    sitterId: sitterId,
                                    sitterName: sitter.name,
                                    timeSlots: timeSlots
                                });
                            }
                        }
                    }
                }
            }
        }
        
        // Generate calendar with available dates
        generateCalendar(
            calendarGrid, 
            year, 
            month, 
            (date) => {
                selectDate(date);
            }, 
            availableDates
        );
        
        // Add time slot tooltips to calendar days
        const calendarDays = calendarGrid.querySelectorAll('.calendar-day');
        calendarDays.forEach(day => {
            const date = day.dataset.date;
            if (date && availableTimeSlots[date]) {
                addTimeSlotPreviewToDay(day, availableTimeSlots[date]);
            }
        });
    } catch (error) {
        console.error("Error generating parent calendar:", error);
    }
}

// Helper function to check if a time slot is within or overlaps a specified range
function isTimeSlotInRange(slotStart, slotEnd, filterStart, filterEnd) {
    // Convert time strings to minutes for easier comparison
    const toMinutes = (timeStr) => {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    };
    
    const slotStartMins = toMinutes(slotStart);
    const slotEndMins = toMinutes(slotEnd);
    const filterStartMins = toMinutes(filterStart);
    const filterEndMins = toMinutes(filterEnd);
    
    // Check if the filter range is contained within or overlaps the slot
    return (
        // Sitter's slot completely contains the filtered time
        (slotStartMins <= filterStartMins && slotEndMins >= filterEndMins) ||
        
        // Sitter's slot partially overlaps with filter range
        (slotStartMins < filterEndMins && slotEndMins > filterStartMins)
    );
}

// Add time slot preview tooltips to calendar days
function addTimeSlotPreviewToDay(dayEl, sittersWithSlots) {
    // Create tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'time-slots-tooltip';
    
    // Collect all unique time slots across sitters
    const allTimeSlots = [];
    sittersWithSlots.forEach(sitter => {
        sitter.timeSlots.forEach(slot => {
            allTimeSlots.push(`${slot.start} - ${slot.end}`);
        });
    });
    
    // Format tooltip content with available times
    const uniqueTimes = [...new Set(allTimeSlots)].slice(0, 3); // Limit to 3 slots to avoid tooltip overflow
    let tooltipContent = uniqueTimes.join('<br>');
    
    if (allTimeSlots.length > 3) {
        tooltipContent += '<br>+ more';
    }
    
    tooltip.innerHTML = tooltipContent;
    
    // Add to day element
    dayEl.appendChild(tooltip);
    
    // Add clock icon to indicate time slots
    const indicator = document.createElement('i');
    indicator.className = 'fas fa-clock time-slot-indicator';
    dayEl.appendChild(indicator);
}

        function selectDate(date) {
            selectedDate = date;
            
            // Update selected day styling
            const calendarDays = document.querySelectorAll('#calendar-grid .calendar-day');
            calendarDays.forEach(day => {
                if (day.dataset.date === date) {
                    day.classList.add('ring-2', 'ring-primary-light', 'dark:ring-primary-dark');
                } else {
                    day.classList.remove('ring-2', 'ring-primary-light', 'dark:ring-primary-dark');
                }
            });
            
            // Load available sitters for this date
            loadAvailableSitters(date);
        }
        
// Replace the loadAvailableSitters function

async function loadAvailableSitters(date) {
    const sittersListEl = document.getElementById('sitters-list');
    const availableSittersEl = document.getElementById('available-sitters');
    const searchQuery = document.getElementById('sitter-search').value.toLowerCase();
    const startTimeFilter = document.getElementById('time-filter-start').value;
    const endTimeFilter = document.getElementById('time-filter-end').value;
    
    // Show loading state
    sittersListEl.innerHTML = '<p class="text-center py-4"><span class="loader" style="width: 24px; height: 24px;"></span></p>';
    
    try {
        // Get parent's connections
        const connections = userProfile.connections || [];
        
        if (connections.length === 0) {
            sittersListEl.innerHTML = '<p class="text-amber-600 dark:text-amber-400">Connect with sitters to see their availability. Use the "Find Sitters" section to search for sitters.</p>';
            return;
        }
        
        // Query only connected sitters who are available on this date
        const availableSitters = [];
        
        for (const sitterId of connections) {
            const sitterDoc = await getDoc(doc(db, "users", sitterId));
            if (sitterDoc.exists()) {
                const sitter = sitterDoc.data();
                if (sitter.availability && sitter.availability.includes(date)) {
                    // Get time slots for this sitter on this date
                    const timeSlots = sitter.timeSlots && sitter.timeSlots[date] ? sitter.timeSlots[date] : [];
                    
                    // If using time filter, check if sitter has slots in the filtered range
                    let matchesTimeFilter = true;
                    if (startTimeFilter && endTimeFilter && timeSlots.length > 0) {
                        matchesTimeFilter = timeSlots.some(slot => 
                            isTimeSlotInRange(slot.start, slot.end, startTimeFilter, endTimeFilter)
                        );
                    }
                    
                    // Check if the sitter matches both time filter and search query
                    if (matchesTimeFilter && (!searchQuery || sitter.name.toLowerCase().includes(searchQuery))) {
                        availableSitters.push({
                            id: sitterId,
                            ...sitter,
                            timeSlots: timeSlots
                        });
                    }
                }
            }
        }
        
        // Get user's bookings for this date
        const bookingsQuery = query(
            collection(db, "bookings"),
            where("parentId", "==", currentUser.uid),
            where("date", "==", date)
        );
        const bookingsSnapshot = await getDocs(bookingsQuery);
        const bookings = [];
        bookingsSnapshot.forEach(doc => {
            bookings.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Update UI - Parse date string properly to local timezone
        const [year, month, day] = date.split('-').map(Number);
        const displayDate = new Date(year, month - 1, day); // Adjust month from 1-based to 0-based
        
        availableSittersEl.querySelector('h3').textContent = `Available Connected Sitters for ${displayDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}`;
        
        if (availableSitters.length === 0) {
            sittersListEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No connected sitters are available for this date</p>';
        } else {
            sittersListEl.innerHTML = '';
            
            availableSitters.forEach(sitter => {
                // Check if we already have a booking with this sitter
                const existingBooking = bookings.find(b => b.sitterId === sitter.id);
                
                const sitterCard = document.createElement('div');
                sitterCard.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
                
                const isFavorite = userProfile.favoriteSitters && userProfile.favoriteSitters.includes(sitter.id);
                
                // Format time slots for display
                let timeSlotsHtml = '';
                if (sitter.timeSlots && sitter.timeSlots.length > 0) {
                    const slots = sitter.timeSlots.filter(slot => {
                        if (!startTimeFilter || !endTimeFilter) return true;
                        return isTimeSlotInRange(slot.start, slot.end, startTimeFilter, endTimeFilter);
                    });
                    
                    if (slots.length > 0) {
                        timeSlotsHtml = '<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Available times: ';
                        const formattedSlots = slots.map(slot => {
                            // Format 24h times to 12h format for display
                            const formatTime = (timeStr) => {
                                const [hours, minutes] = timeStr.split(':').map(Number);
                                const period = hours >= 12 ? 'PM' : 'AM';
                                const displayHours = hours % 12 || 12;
                                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
                            };
                            return `${formatTime(slot.start)}-${formatTime(slot.end)}`;
                        }).join(', ');
                        timeSlotsHtml += formattedSlots + '</div>';
                    }
                }
                
                sitterCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center">
                                <h4 class="font-medium">${sitter.name}</h4>
                                <button class="ml-2 text-gray-400 hover:text-yellow-500 dark:hover:text-yellow-400 favorite-btn ${isFavorite ? 'text-yellow-500 dark:text-yellow-400' : ''}" data-sitter-id="${sitter.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-300">Age: ${sitter.age} | Experience: ${sitter.experience} year${sitter.experience !== 1 ? 's' : ''}</p>
                            ${timeSlotsHtml}
                        </div>
                        <div>
                            ${existingBooking 
                                ? `<span class="text-sm px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full">${existingBooking.status === 'pending' ? 'Requested' : existingBooking.status}</span>` 
                                : `<button class="book-btn text-sm px-3 py-1 bg-primary-light hover:bg-opacity-90 dark:bg-primary-dark text-white rounded-md" data-sitter-id="${sitter.id}">Book</button>`
                            }
                        </div>
                    </div>
                `;
                
                sittersListEl.appendChild(sitterCard);
                
                // Add event listeners
                const bookBtn = sitterCard.querySelector('.book-btn');
                if (bookBtn) {
                    bookBtn.addEventListener('click', () => showBookingModal(sitter, date));
                }
                
                const favoriteBtn = sitterCard.querySelector('.favorite-btn');
                favoriteBtn.addEventListener('click', () => toggleFavoriteSitter(sitter.id, favoriteBtn));
            });
        }
    } catch (error) {
        console.error("Error loading available sitters:", error);
        sittersListEl.innerHTML = '<p class="text-red-500">Error loading sitters. Please try again.</p>';
    }
}


        async function bookSitter(sitterId, date) {
            try {
                // Create booking request
                const booking = {
                    parentId: currentUser.uid,
                    sitterId: sitterId,
                    date: date,
                    status: 'pending',
                    createdAt: serverTimestamp()
                };
                
                // Add booking to Firestore
                await addDoc(collection(db, "bookings"), booking);
                
                // Get sitter details for email notification
                const sitterDoc = await getDoc(doc(db, "users", sitterId));
                if (sitterDoc.exists()) {
                    const sitter = sitterDoc.data();
                    
                    // Format date for email
                    const [year, month, day] = date.split('-').map(Number);
                    const bookingDate = new Date(year, month - 1, day);
                    const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                        weekday: 'long',
                        month: 'long', 
                        day: 'numeric'
                    });
                    
                    // Send notification email to sitter
                    try {
                        await notifySitterOfBookingRequest(
                            sitter.email,
                            sitter.name,
                            userProfile.name,
                            formattedDate
                        );
                        console.log("Booking request email sent to sitter");
                    } catch (emailError) {
                        console.error("Error sending booking request email:", emailError);
                    }
                }
                
                // Reload available sitters to update UI
                loadAvailableSitters(date);
                
                // Reload upcoming bookings
                loadUpcomingBookings();
            } catch (error) {
                console.error("Error booking sitter:", error);
                alert("Failed to book sitter. Please try again.");
            }
        }
        
        async function toggleFavoriteSitter(sitterId, btnElement) {
            try {
                const userRef = doc(db, "users", currentUser.uid);
                
                if (btnElement.classList.contains('text-yellow-500') || btnElement.classList.contains('text-yellow-400')) {
                    // Remove from favorites
                    await updateDoc(userRef, {
                        favoriteSitters: arrayRemove(sitterId)
                    });
                    
                    btnElement.classList.remove('text-yellow-500', 'text-yellow-400');
                    btnElement.classList.add('text-gray-400');
                    
                    // Update local user profile
                    userProfile.favoriteSitters = userProfile.favoriteSitters.filter(id => id !== sitterId);
                } else {
                    // Add to favorites
                    await updateDoc(userRef, {
                        favoriteSitters: arrayUnion(sitterId)
                    });
                    
                    btnElement.classList.remove('text-gray-400');
                    btnElement.classList.add('text-yellow-500', 'dark:text-yellow-400');
                    
                    // Update local user profile
                    if (!userProfile.favoriteSitters) {
                        userProfile.favoriteSitters = [];
                    }
                    userProfile.favoriteSitters.push(sitterId);
                }
                
                // Reload favorite sitters
                loadFavoriteSitters();
            } catch (error) {
                console.error("Error toggling favorite sitter:", error);
                alert("Failed to update favorites. Please try again.");
            }
        }
        
        async function loadUpcomingBookings() {
            const upcomingBookingsEl = document.getElementById('upcoming-bookings');
            
            try {
                // Query user's bookings - include cancelled and declined
                const bookingsQuery = query(
                    collection(db, "bookings"),
                    where("parentId", "==", currentUser.uid)
                );
                const bookingsSnapshot = await getDocs(bookingsQuery);
                
                // Get all bookings
                const bookings = [];
                bookingsSnapshot.forEach(doc => {
                    bookings.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by date
                bookings.sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Filter for future bookings and non-cancelled ones
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const relevantBookings = bookings.filter(booking => 
                    (new Date(booking.date) >= today || booking.status === 'declined' || booking.status === 'cancelled')
                );
                
                // Check for cancellations and show notification
                const cancelledBookings = relevantBookings.filter(booking => 
                    booking.status === 'cancelled' && 
                    booking.cancelledBy !== currentUser.uid && 
                    booking.wasNotified === false
                );
                
                if (cancelledBookings.length > 0) {
                    // Show notification for the most recent cancellation
                    const mostRecent = cancelledBookings.sort((a, b) => 
                        (b.cancelledAt?.toDate() || new Date()) - (a.cancelledAt?.toDate() || new Date())
                    )[0];
                    
                    showCancellationNotification(mostRecent);
                    
                    // Mark all as notified
                    for (const booking of cancelledBookings) {
                        await updateDoc(doc(db, "bookings", booking.id), {
                            wasNotified: true
                        });
                    }
                }
                
                // Get sitter details for each booking
                const bookingsWithSitterDetails = await Promise.all(relevantBookings.map(async booking => {
                    if (booking.sitterId) {
                        const sitterDoc = await getDoc(doc(db, "users", booking.sitterId));
                        if (sitterDoc.exists()) {
                            return {
                                ...booking,
                                sitterName: sitterDoc.data().name
                            };
                        }
                    }
                    return booking;
                }));
                
                // Update UI
                if (bookingsWithSitterDetails.length === 0) {
                    upcomingBookingsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No upcoming bookings</p>';
                } else {
                    upcomingBookingsEl.innerHTML = '';
                    
                    bookingsWithSitterDetails.forEach(booking => {
                        // Skip if the booking was cancelled and already notified
                        if (booking.status === 'cancelled' && booking.wasNotified === true && booking.cancelledBy !== currentUser.uid) {
                            return;
                        }
                        
                        const bookingEl = document.createElement('div');
                        bookingEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 text-sm mb-3';
                        bookingEl.id = `booking-${booking.id}`;
                        
                        // Format date consistently
                        const [year, month, day] = booking.date.split('-').map(Number);
                        const bookingDate = new Date(year, month - 1, day);
                        
                        const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric'
                        });
                        
                        // Status badge
                        let statusBadge = '';
                        if (booking.status === 'confirmed') {
                            statusBadge = '<span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full text-xs">Confirmed</span>';
                        } else if (booking.status === 'pending') {
                            statusBadge = '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-full text-xs">Pending</span>';
                        } else if (booking.status === 'declined') {
                            statusBadge = '<span class="px-2 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-full text-xs">Declined</span>';
                        } else if (booking.status === 'cancelled') {
                            statusBadge = '<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full text-xs">Cancelled</span>';
                        }
                        
                        // Add X button for declined bookings and cancelled bookings, and add cancel buttons as needed
                        let actionButtons = '';
                        
                        if (booking.status === 'declined' || booking.status === 'cancelled') {
                            actionButtons = `<button class="remove-booking-btn mt-2 text-xs px-2 py-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300" data-booking-id="${booking.id}">
                                <i class="fas fa-times"></i> Remove
                            </button>`;
                        }
                        
                        if (booking.status === 'pending') {
                            actionButtons += `<button class="cancel-booking-btn mt-2 text-xs px-2 py-1 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-booking-id="${booking.id}">
                                Cancel Request
                            </button>`;
                        }
                        
                        if (booking.status === 'confirmed') {
                            actionButtons += `<button class="cancel-confirmed-btn mt-2 text-xs px-2 py-1 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-booking-id="${booking.id}">
                                Cancel Booking
                            </button>`;
                        }
                        
                        // For cancelled bookings by the current user, show who cancelled it
                        let cancellationInfo = '';
                        if (booking.status === 'cancelled' && booking.cancelledBy === currentUser.uid) {
                            cancellationInfo = `<p class="text-xs text-gray-500 italic mt-1">You cancelled this booking</p>`;
                        } else if (booking.status === 'cancelled') {
                            cancellationInfo = `<p class="text-xs text-gray-500 italic mt-1">Cancelled by ${booking.cancelledByName || 'the other party'}</p>`;
                        }
                        
                        bookingEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${formattedDate}</p>
                                    <p>with ${booking.sitterName || 'Unknown Sitter'}</p>
                                    ${cancellationInfo}
                                </div>
                                <div class="flex items-center">
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="flex justify-end">
                                ${actionButtons}
                            </div>
                        `;
                        
                        upcomingBookingsEl.appendChild(bookingEl);
                        
                        // Add event listeners for buttons
                        const cancelBtn = bookingEl.querySelector('.cancel-booking-btn');
                        if (cancelBtn) {
                            cancelBtn.addEventListener('click', () => cancelBooking(booking.id));
                        }
                        
                        const cancelConfirmedBtn = bookingEl.querySelector('.cancel-confirmed-btn');
                        if (cancelConfirmedBtn) {
                            cancelConfirmedBtn.addEventListener('click', () => {
                                showConfirmationPopup(
                                    "Cancel Confirmed Booking",
                                    `Are you sure you want to cancel your booking with ${booking.sitterName} on ${formattedDate}? This action cannot be undone.`,
                                    () => cancelBooking(booking.id)
                                );
                            });
                        }
                        
                        // Add event listener for remove button on declined and cancelled bookings
                        const removeBtn = bookingEl.querySelector('.remove-booking-btn');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', () => removeDeclinedBooking(booking.id));
                        }
                    });
                }
            } catch (error) {
                console.error("Error loading upcoming bookings:", error);
                upcomingBookingsEl.innerHTML = '<p class="text-red-500">Error loading bookings. Please try again.</p>';
            }
        }
        
        // Inside cancelBooking function
async function cancelBooking(bookingId) {
    try {
        // Get booking details first
        const bookingDoc = await getDoc(doc(db, "bookings", bookingId));
        if (!bookingDoc.exists()) {
            throw new Error("Booking not found");
        }
        
        const booking = bookingDoc.data();
        
        // Update booking to cancelled status instead of deleting
        await updateDoc(doc(db, "bookings", bookingId), {
            status: 'cancelled',
            cancelledBy: currentUser.uid,
            cancelledAt: serverTimestamp(),
            cancelledByName: userProfile.name,
            wasNotified: false
        });
        
        // Get sitter details for email notification
        const sitterDoc = await getDoc(doc(db, "users", booking.sitterId));
        if (sitterDoc.exists()) {
            const sitter = sitterDoc.data();
            
            // Format date for email
            const [year, month, day] = booking.date.split('-').map(Number);
            const bookingDate = new Date(year, month - 1, day);
            const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric'
            });
            
            // Send cancellation email to sitter
            try {
                await notifySitterOfCancelledBooking(
                    sitter.email,
                    sitter.name,
                    userProfile.name,
                    formattedDate
                );
                console.log("Booking cancellation email sent to sitter");
            } catch (emailError) {
                console.error("Error sending cancellation email:", emailError);
            }
        }
        
        alert("Booking has been cancelled successfully.");
        
        // Reload upcoming bookings
        loadUpcomingBookings();
        
        // Reload available sitters if a date is selected
        if (selectedDate) {
            loadAvailableSitters(selectedDate);
        }
    } catch (error) {
        console.error("Error canceling booking:", error);
        alert("Failed to cancel booking. Please try again.");
    }
}

        async function removeDeclinedBooking(bookingId) {
            try {
                // Delete the booking from Firestore
                await deleteDoc(doc(db, "bookings", bookingId));
                
                // Remove from UI - handle both parent and sitter views
                const bookingEl = document.getElementById(`booking-${bookingId}`);
                if (bookingEl) {
                    bookingEl.remove();
                    
                    // If no bookings left in parent view, show "No upcoming bookings" message
                    const upcomingBookingsEl = document.getElementById('upcoming-bookings');
                    if (upcomingBookingsEl && upcomingBookingsEl.children.length === 0) {
                        upcomingBookingsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No upcoming bookings</p>';
                    }
                }
                
                // Also try to remove from sitter view if present
                const sitterBookingEl = document.getElementById(`sitter-booking-${bookingId}`);
                if (sitterBookingEl) {
                    sitterBookingEl.remove();
                    
                    // If no bookings left in sitter view, show "No confirmed bookings" message
                    const confirmedBookingsEl = document.getElementById('confirmed-bookings');
                    if (confirmedBookingsEl && confirmedBookingsEl.children.length === 0 || 
                        confirmedBookingsEl.querySelectorAll('.shadow').length === 0) {
                        confirmedBookingsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No confirmed bookings</p>';
                    }
                }
                
                alert("Booking removed successfully");
            } catch (error) {
                console.error("Error removing booking:", error);
                console.error("Error stack:", error.stack);
                alert("Failed to remove booking notification. Please try again.");
            }
        }
        
        async function loadFavoriteSitters() {
            const favoriteSittersEl = document.getElementById('favorite-sitters');
            
            try {
                // Check if user has any favorite sitters
                if (!userProfile.favoriteSitters || userProfile.favoriteSitters.length === 0) {
                    favoriteSittersEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No favorite sitters yet</p>';
                    return;
                }
                
                // Get details for each favorite sitter
                const favoriteDetails = await Promise.all(userProfile.favoriteSitters.map(async sitterId => {
                    const sitterDoc = await getDoc(doc(db, "users", sitterId));
                    return {
                        id: sitterId,
                        ...sitterDoc.data()
                    };
                }));
                
                // Update UI
                favoriteSittersEl.innerHTML = '';
                
                favoriteDetails.forEach(sitter => {
                    const sitterEl = document.createElement('div');
                    sitterEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 text-sm';
                    
                    sitterEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${sitter.name}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-300">Age: ${sitter.age} | Experience: ${sitter.experience} year${sitter.experience !== 1 ? 's' : ''}</p>
                            </div>
                            <button class="unfavorite-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-600 dark:hover:text-yellow-500" data-sitter-id="${sitter.id}">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    `;
                    
                    favoriteSittersEl.appendChild(sitterEl);
                    
                    // Add event listener for unfavorite button
                    const unfavoriteBtn = sitterEl.querySelector('.unfavorite-btn');
                    unfavoriteBtn.addEventListener('click', () => {
                        toggleFavoriteSitter(sitter.id, unfavoriteBtn);
                    });
                });
            } catch (error) {
                console.error("Error loading favorite sitters:", error);
                favoriteSittersEl.innerHTML = '<p class="text-red-500">Error loading favorites. Please try again.</p>';
            }
        }
        
        // Teen Sitter Dashboard Setup
        async function setupSitterDashboard() {
        // Initialize month selector and calendar
            generateMonthOptions(sitterMonthSelector);
    
        // Set up time slot modal
            setupTimeSlotModal();
            
            // Fix the calendar header duplication issue
            const calendarParent = document.getElementById('sitter-calendar-grid').parentNode;
            const oldHeaders = calendarParent.querySelectorAll('.calendar-header');
            
            // Remove any existing calendar headers
            if (oldHeaders.length > 0) {
                for (let i = 0; i < oldHeaders.length; i++) {
                    oldHeaders[i].remove();
                }
            }
            
            // Create a new calendar header
            const calendarHeader = document.createElement('div');
            calendarHeader.id = 'sitter-calendar-header';
            calendarHeader.className = 'grid grid-cols-7 gap-1 mb-2 text-center font-medium calendar-header';
            
            // Add day names to the header
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                calendarHeader.appendChild(dayEl);
            });
            
            const calendarContainer = document.createElement('div');
            calendarContainer.classList.add('calendar-container');
            
            // Remove the calendar grid from its parent
            const calendarGrid = document.getElementById('sitter-calendar-grid');
            if (calendarGrid.parentNode) {
                calendarGrid.parentNode.removeChild(calendarGrid);
            }
            
            // Add the calendar header and grid to the new container
            calendarContainer.appendChild(calendarHeader);
            calendarContainer.appendChild(calendarGrid);
            
            // Add the container to the parent
            calendarParent.appendChild(calendarContainer);
            
            // Handle month selection change
            sitterMonthSelector.addEventListener('change', () => {
                const [year, month] = sitterMonthSelector.value.split('-').map(Number);
                generateSitterCalendar(year, month);
            });
            
            // Initial calendar generation
            const initialDate = sitterMonthSelector.value.split('-').map(Number);
            generateSitterCalendar(initialDate[0], initialDate[1]);
            
            // Load booking requests
            loadBookingRequests();
            
            // Load confirmed bookings
            loadConfirmedBookings();
            
            // Load connection requests for sitters
            loadSitterConnectionRequests();
            
            // Load connected parents
            loadConnectedParents();

            // Set up time slot modal
            setupTimeSlotModal();
        }
        
        async function generateSitterCalendar(year, month) {
            const calendarGrid = document.getElementById('sitter-calendar-grid');
            
            try {
                // Get sitter's availability
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                const userData = userDoc.data();
                const availability = userData.availability || [];
                const timeSlots = userData.timeSlots || {};
                
                // Store in user profile
                userProfile.timeSlots = timeSlots;
                
                // Get sitter's bookings
                const bookingsQuery = query(
                    collection(db, "bookings"),
                    where("sitterId", "==", currentUser.uid),
                    where("status", "==", "confirmed")
                );
                const bookingsSnapshot = await getDocs(bookingsQuery);
                const bookedDates = [];
                bookingsSnapshot.forEach(doc => {
                    bookedDates.push(doc.data().date);
                });
                
                // Generate calendar with availability and bookings
                generateCalendar(
                    calendarGrid,
                    year,
                    month,
                    (date, dayEl) => {
                        toggleAvailability(date, dayEl);
                    },
                    availability,
                    bookedDates
                );
                
                // Add time slot indicators and tooltips to days with time slots
                const calendarDays = calendarGrid.querySelectorAll('.calendar-day');
                calendarDays.forEach(day => {
                    const date = day.dataset.date;
                    if (date && timeSlots[date] && timeSlots[date].length > 0) {
                        day.classList.add('day-with-slots');
                        updateDayTimeSlotTooltip(day, timeSlots[date]);
                    }
                });
            } catch (error) {
                console.error("Error generating sitter calendar:", error);
            }
        }
        
                // Add this function BEFORE the toggleAvailability function
        function showTimeSlotModal(date, dayEl) {
            const modal = document.getElementById('time-slot-modal');
            const dateHeader = document.getElementById('time-slot-modal-date');
            const container = document.getElementById('time-slots-container');
            
            if (!modal || !dateHeader || !container) {
                console.error("Missing time slot modal elements");
                alert("There was a problem showing the time slot modal. Please try again.");
                return;
            }
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
            
            // Store the current date and day element
            currentSelectedDate = date;
            currentDayElement = dayEl;
            
            // Format date for display
            const [year, month, day] = date.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric'
            });
            
            // Set modal header
            dateHeader.textContent = `Available Times for ${formattedDate}`;
            
            // Clear existing time slots
            container.innerHTML = '';
            
            // Check if this date already has time slots
            if (userProfile.timeSlots && userProfile.timeSlots[date]) {
                currentTimeSlots = userProfile.timeSlots[date];
                
                // Add existing time slots to modal
                currentTimeSlots.forEach(slot => {
                    addNewTimeSlot(slot.start, slot.end);
                });
            } else {
                // Add one empty time slot by default
                addNewTimeSlot();
                currentTimeSlots = [];
            }
            
            // Show the modal
            modal.classList.remove('hidden');
            
            // Set up the delete button if needed
            const buttonsContainer = document.querySelector('#time-slot-modal .flex.justify-between.items-center.mb-4');
            if (buttonsContainer && !document.getElementById('delete-availability-btn')) {
                const rightDiv = buttonsContainer.querySelector('div') || document.createElement('div');
                rightDiv.className = 'flex space-x-2';
                
                // Add delete button
                rightDiv.innerHTML = `
                    <button id="delete-availability-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i> Delete Availability
                    </button>
                    <button id="save-time-slots-btn" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600">
                        <i class="fas fa-save mr-2"></i> Save
                    </button>
                `;
                
                // Add right div to container if not already there
                if (!buttonsContainer.contains(rightDiv)) {
                    buttonsContainer.appendChild(rightDiv);
                }
            }
            
            // Set up button event listeners
            setupTimeSlotModal();
        }


        async function toggleAvailability(date, dayEl) {
            try {
                // Check if day is already booked
                if (dayEl.classList.contains('day-booked')) {
                    alert("You already have a confirmed booking for this date. You cannot change your availability.");
                    return;
                }
                
                // Show time slot modal instead of directly toggling
                showTimeSlotModal(date, dayEl);
                
            } catch (error) {
                console.error("Error toggling availability:", error);
                alert("Failed to update availability. Please try again.");
            }
        }

        // Variables for time slot modal
        let currentSelectedDate = null;
        let currentTimeSlots = [];
        let currentDayElement = null;

        // Function to add a new time slot to the modal - MOVED to global scope
        function addNewTimeSlot(startTime = '', endTime = '') {
            const template = document.getElementById('time-slot-template').firstElementChild;
            const container = document.getElementById('time-slots-container');
            
            const newSlot = template.cloneNode(true);
            container.appendChild(newSlot);
            
            // Set initial values if provided
            if (startTime) newSlot.querySelector('.slot-start-time').value = startTime;
            if (endTime) newSlot.querySelector('.slot-end-time').value = endTime;
            
            // Add remove button functionality
            const removeBtn = newSlot.querySelector('.remove-time-slot-btn');
            removeBtn.addEventListener('click', () => {
                container.removeChild(newSlot);
            });
        }


// Setup time slot modal functionality
function setupTimeSlotModal() {
    const modal = document.getElementById('time-slot-modal');
    const closeBtn = document.getElementById('close-time-slot-modal');
    const addBtn = document.getElementById('add-time-slot-btn');
    const saveBtn = document.getElementById('save-time-slots-btn');
    
    // Close modal button
    closeBtn.onclick = () => {
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Re-enable scrolling
    };
    
    // Add time slot button
    addBtn.onclick = () => {
        addNewTimeSlot();
    };
    
    // Save button
    saveBtn.onclick = async () => {
        // Add click animation
        saveBtn.classList.add('scale-95', 'opacity-75');
        setTimeout(() => {
            saveBtn.classList.remove('scale-95', 'opacity-75');
        }, 150);
        
        await saveTimeSlots();
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Re-enable scrolling
        
        // Show toast notification
        showNotification("Success", "Availability updated successfully!", "green");
    };
    
    // Find the bottom button container and reorganize it
    const bottomButtonsContainer = document.querySelector('#time-slot-modal .flex.justify-between.items-center.mb-4');
    
    if (bottomButtonsContainer) {
        // Change layout from justify-between to space-x-3
        bottomButtonsContainer.className = 'flex items-center mb-4 space-x-3';
        
        // Remove existing delete button if any
        const existingDeleteBtn = document.getElementById('delete-availability-btn');
        if (existingDeleteBtn) {
            existingDeleteBtn.remove();
        }
        
        // Create delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.id = 'delete-availability-btn';
        deleteBtn.className = 'inline-flex items-center px-2 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-500 hover:bg-red-600';
        deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Delete Availability';
        
        // Insert delete button between add and save buttons
        bottomButtonsContainer.insertBefore(deleteBtn, saveBtn);
        
        // Add click handler for the delete button
        deleteBtn.onclick = async () => {
            // Add click animation
            deleteBtn.classList.add('scale-95', 'opacity-75');
            setTimeout(() => {
            deleteBtn.classList.remove('scale-95', 'opacity-75');
            }, 150);
            
            await deleteAvailability();
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // Re-enable scrolling
            
            // Show success notification after modal closes
            showNotification("Success", "Availability deleted successfully!", "green");
        };
    }
}

// Make sure to also include the deleteAvailability function if it doesn't exist
async function deleteAvailability() {
    try {
        console.log("Deleting availability for date:", currentSelectedDate);
        
        // Update Firebase
        const userRef = doc(db, "users", currentUser.uid);
        
        // Get current availability
        const userDoc = await getDoc(userRef);
        const userData = userDoc.data();
        const currentAvailability = userData.availability || [];
        const currentTimeSlots = userData.timeSlots || {};
        
        // Remove date from availability
        if (currentAvailability.includes(currentSelectedDate)) {
            await updateDoc(userRef, {
                availability: arrayRemove(currentSelectedDate)
            });
            
            // Update local user profile
            if (userProfile.availability) {
                userProfile.availability = userProfile.availability.filter(d => d !== currentSelectedDate);
            }
            
            // Update UI
            currentDayElement.classList.remove('day-available');
        }
        
        // Remove time slots for this date
        if (currentTimeSlots[currentSelectedDate]) {
            const newTimeSlots = { ...currentTimeSlots };
            delete newTimeSlots[currentSelectedDate];
            
            await updateDoc(userRef, {
                timeSlots: newTimeSlots
            });
            
            // Update local user profile
            if (userProfile.timeSlots && userProfile.timeSlots[currentSelectedDate]) {
                delete userProfile.timeSlots[currentSelectedDate];
            }
        }
        
        // Remove time slot indicator
        currentDayElement.classList.remove('day-with-slots');
        removeTimeSlotTooltip(currentDayElement);
        
        // Show success notification
        showNotification("Success", "Availability deleted successfully!", "green");
    } catch (error) {
        console.error("Error deleting availability:", error);
        showNotification("Error", "Failed to delete availability. Please try again.", "red");
    }
}

        // Save time slots to Firebase
        async function saveTimeSlots() {
            try {
                console.log("Saving time slots for date:", currentSelectedDate);
                
                // Get all time slots from the modal
                const slots = [];
                const slotElements = document.querySelectorAll('#time-slots-container .time-slot');
                
                slotElements.forEach(slotEl => {
                    const startTime = slotEl.querySelector('.slot-start-time').value;
                    const endTime = slotEl.querySelector('.slot-end-time').value;
                    
                    // Only add valid time slots
                    if (startTime && endTime) {
                        slots.push({
                            start: startTime,
                            end: endTime
                        });
                    }
                });
                
                console.log("Collected time slots:", slots);
                
                // Update Firebase
                const userRef = doc(db, "users", currentUser.uid);
                
                // Get current availability
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();
                const currentAvailability = userData.availability || [];
                const currentTimeSlots = userData.timeSlots || {};
                
                if (slots.length > 0) {
                    // If there are time slots, mark the date as available and add time slots
                    if (!currentAvailability.includes(currentSelectedDate)) {
                        console.log("Adding date to availability:", currentSelectedDate);
                        await updateDoc(userRef, {
                            availability: arrayUnion(currentSelectedDate)
                        });
                        
                        // Update local user profile
                        if (!userProfile.availability) {
                            userProfile.availability = [];
                        }
                        if (!userProfile.availability.includes(currentSelectedDate)) {
                            userProfile.availability.push(currentSelectedDate);
                        }
                        
                        // Update UI
                        currentDayElement.classList.add('day-available');
                    }
                    
                    // Update time slots
                    console.log("Updating time slots for date:", currentSelectedDate);
                    const newTimeSlots = {
                        ...currentTimeSlots,
                        [currentSelectedDate]: slots
                    };
                    
                    await updateDoc(userRef, {
                        timeSlots: newTimeSlots
                    });
                    
                    // Update local user profile
                    if (!userProfile.timeSlots) {
                        userProfile.timeSlots = {};
                    }
                    userProfile.timeSlots[currentSelectedDate] = slots;
                    
                    // Update UI to show time slot indicator
                    currentDayElement.classList.add('day-with-slots');
                    
                    // Update or add tooltip
                    updateDayTimeSlotTooltip(currentDayElement, slots);
                    
                } else {
                    // If no time slots, remove availability for this date
                    if (currentAvailability.includes(currentSelectedDate)) {
                        console.log("Removing date from availability:", currentSelectedDate);
                        await updateDoc(userRef, {
                            availability: arrayRemove(currentSelectedDate)
                        });
                        
                        // Update local user profile
                        if (userProfile.availability) {
                            userProfile.availability = userProfile.availability.filter(d => d !== currentSelectedDate);
                        }
                        
                        // Update UI
                        currentDayElement.classList.remove('day-available');
                    }
                    
                    // Remove time slots for this date
                    if (currentTimeSlots[currentSelectedDate]) {
                        console.log("Removing time slots for date:", currentSelectedDate);
                        const newTimeSlots = { ...currentTimeSlots };
                        delete newTimeSlots[currentSelectedDate];
                        
                        await updateDoc(userRef, {
                            timeSlots: newTimeSlots
                        });
                        
                        // Update local user profile
                        if (userProfile.timeSlots && userProfile.timeSlots[currentSelectedDate]) {
                            delete userProfile.timeSlots[currentSelectedDate];
                        }
                    }
                    
                    // Remove time slot indicator
                    currentDayElement.classList.remove('day-with-slots');
                    removeTimeSlotTooltip(currentDayElement);
                }
                
                console.log("Time slots saved successfully");
                
                // Show success notification instead of alert
                showNotification("Success", "Availability updated successfully!", "green");
            } catch (error) {
                console.error("Error saving time slots:", error);
                console.error("Error details:", error.message);
                console.error("Stack trace:", error.stack);
                
                // Show error notification
                showNotification("Error", "Failed to save availability. Please try again.", "red");
            }
        }

        // Add this function to show notifications
        // Make sure the toast notification function is fully implemented
function showNotification(title, message, type = "green") {
    const notificationArea = document.getElementById('notification-area');
    const messageEl = document.getElementById('notification-message');
    const detailsEl = document.getElementById('notification-details');
    const dismissBtn = document.getElementById('dismiss-notification');
    const svgEl = notificationArea.querySelector('svg');
    const notificationDiv = notificationArea.querySelector('div');
    
    // Set notification content
    messageEl.textContent = title;
    detailsEl.textContent = message;
    
    // Remove existing color classes
    notificationDiv.className = notificationDiv.className
        .replace(/bg-\w+-\d+/g, '')
        .replace(/border-\w+-\d+/g, '')
        .replace(/text-\w+-\d+/g, '');
    
    svgEl.className = svgEl.className.replace(/text-\w+-\d+/g, '');
    dismissBtn.className = dismissBtn.className
        .replace(/bg-\w+-\d+/g, '')
        .replace(/hover:bg-\w+-\d+/g, '');
    
    // Set color based on type
    if (type === "red") {
        notificationDiv.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        svgEl.classList.add('text-red-500');
        dismissBtn.classList.add('bg-red-500', 'hover:bg-red-600');
    } else {
        notificationDiv.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        svgEl.classList.add('text-green-500');
        dismissBtn.classList.add('bg-green-500', 'hover:bg-green-600');
    }
    
    // Show notification
    notificationArea.classList.remove('hidden');
    
    // Set up dismiss button
    const newDismissBtn = dismissBtn.cloneNode(true);
    dismissBtn.parentNode.replaceChild(newDismissBtn, dismissBtn);
    newDismissBtn.addEventListener('click', () => {
        notificationArea.classList.add('hidden');
    });
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        notificationArea.classList.add('hidden');
    }, 5000);
}


        // Update day element with time slot tooltip
        function updateDayTimeSlotTooltip(dayEl, slots) {
            // Remove any existing tooltip
            removeTimeSlotTooltip(dayEl);
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'time-slots-tooltip';
            
            // Add time slots to tooltip
            const timesText = slots.map(slot => `${slot.start} - ${slot.end}`).join('<br>');
            tooltip.innerHTML = timesText;
            
            // Add to day element
            dayEl.appendChild(tooltip);
            
            // Add clock icon
            const indicator = document.createElement('i');
            indicator.className = 'fas fa-clock time-slot-indicator';
            dayEl.appendChild(indicator);
        }

        // Remove time slot tooltip
        function removeTimeSlotTooltip(dayEl) {
            const existingTooltip = dayEl.querySelector('.time-slots-tooltip');
            if (existingTooltip) {
                dayEl.removeChild(existingTooltip);
            }
            
            const existingIndicator = dayEl.querySelector('.time-slot-indicator');
            if (existingIndicator) {
                dayEl.removeChild(existingIndicator);
            }
        }
        
        async function loadBookingRequests() {
            const bookingRequestsEl = document.getElementById('booking-requests');
            
            try {
                // Query pending booking requests
                const bookingsQuery = query(
                    collection(db, "bookings"),
                    where("sitterId", "==", currentUser.uid),
                    where("status", "==", "pending")
                );
                const bookingsSnapshot = await getDocs(bookingsQuery);
                
                // Get all booking requests
                const bookingRequests = [];
                bookingsSnapshot.forEach(doc => {
                    bookingRequests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Sort by date
                bookingRequests.sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Get parent details for each booking
                const requestsWithParentDetails = await Promise.all(bookingRequests.map(async booking => {
                    const parentDoc = await getDoc(doc(db, "users", booking.parentId));
                    return {
                        ...booking,
                        parentName: parentDoc.data().name
                    };
                }));
                
                // Update UI
                if (requestsWithParentDetails.length === 0) {
                    bookingRequestsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No pending requests</p>';
                } else {
                    bookingRequestsEl.innerHTML = '';
                    
                    requestsWithParentDetails.forEach(request => {
                        const requestEl = document.createElement('div');
                        requestEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 text-sm';
                        
                        // Format date
                        const requestDate = new Date(request.date);
                        const formattedDate = requestDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric'
                        });
                        
                        requestEl.innerHTML = `
                            <div>
                                <p class="font-medium">${formattedDate}</p>
                                <p>from ${request.parentName}</p>
                                <div class="flex space-x-2 mt-2">
                                    <button class="accept-request-btn px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md text-xs" data-booking-id="${request.id}">
                                        Accept
                                    </button>
                                    <button class="decline-request-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md text-xs" data-booking-id="${request.id}">
                                        Decline
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        bookingRequestsEl.appendChild(requestEl);
                        
                        // Add event listeners
                        const acceptBtn = requestEl.querySelector('.accept-request-btn');
                        acceptBtn.addEventListener('click', () => updateBookingStatus(request.id, 'confirmed'));
                        
                        const declineBtn = requestEl.querySelector('.decline-request-btn');
                        declineBtn.addEventListener('click', () => updateBookingStatus(request.id, 'declined'));
                    });
                }
            } catch (error) {
                console.error("Error loading booking requests:", error);
                bookingRequestsEl.innerHTML = '<p class="text-red-500">Error loading requests. Please try again.</p>';
            }
        }
        
        async function loadConfirmedBookings() {
            const confirmedBookingsEl = document.getElementById('confirmed-bookings');
            
            try {
                // Query confirmed and cancelled bookings
                const bookingsQuery = query(
                    collection(db, "bookings"),
                    where("sitterId", "==", currentUser.uid),
                    where("status", "in", ["confirmed", "cancelled"])
                );
                const bookingsSnapshot = await getDocs(bookingsQuery);
                
                // Get all confirmed bookings
                const bookings = [];
                bookingsSnapshot.forEach(doc => {
                    bookings.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Check for cancellations to show notification
                const cancelledBookings = bookings.filter(booking => 
                    booking.status === 'cancelled' && 
                    booking.cancelledBy !== currentUser.uid && 
                    booking.wasNotified === false
                );
                
                if (cancelledBookings.length > 0) {
                    // Show notification for the most recent cancellation
                    const mostRecent = cancelledBookings.sort((a, b) => 
                        (b.cancelledAt?.toDate() || new Date()) - (a.cancelledAt?.toDate() || new Date())
                    )[0];
                    
                    showCancellationNotification(mostRecent);
                    
                    // Mark all as notified
                    for (const booking of cancelledBookings) {
                        await updateDoc(doc(db, "bookings", booking.id), {
                            wasNotified: true
                        });
                    }
                }
                
                // Sort by date
                bookings.sort((a, b) => {
                    return new Date(a.date) - new Date(b.date);
                });
                
                // Filter for future bookings with confirmed status and cancelled bookings
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const relevantBookings = bookings.filter(booking => 
                    (booking.status === 'confirmed' && new Date(booking.date) >= today) ||
                    booking.status === 'cancelled'
                );
                
                // If we have no relevant bookings, show "No confirmed bookings"
                if (relevantBookings.length === 0) {
                    confirmedBookingsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No confirmed bookings</p>';
                    return;
                }
                
                // Get parent details for each booking
                const bookingsWithParentDetails = await Promise.all(relevantBookings.map(async booking => {
                    try {
                        const parentDoc = await getDoc(doc(db, "users", booking.parentId));
                        if (parentDoc.exists()) {
                            return {
                                ...booking,
                                parentName: parentDoc.data().name
                            };
                        } else {
                            return {
                                ...booking,
                                parentName: "Unknown Parent"
                            };
                        }
                    } catch (error) {
                        console.error(`Error getting parent details for booking ${booking.id}:`, error);
                        return {
                            ...booking,
                            parentName: "Unknown Parent"
                        };
                    }
                }));
                
                // Update UI
                confirmedBookingsEl.innerHTML = '';
                
                bookingsWithParentDetails.forEach(booking => {
                    // Skip if the booking was cancelled by the other party and already notified
                    if (booking.status === 'cancelled' && booking.cancelledBy !== currentUser.uid && booking.wasNotified === true) {
                        return;
                    }
                    
                    const bookingEl = document.createElement('div');
                    bookingEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 text-sm mb-3';
                    bookingEl.id = `sitter-booking-${booking.id}`;
                    
                    try {
                        // Format date
                        const [year, month, day] = booking.date.split('-').map(Number);
                        const bookingDate = new Date(year, month - 1, day);
                        
                        if (isNaN(bookingDate.getTime())) {
                            throw new Error("Invalid date");
                        }
                        
                        const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric'
                        });
                        
                        // Add status badge for cancelled bookings
                        let statusBadge = '';
                        let cancellationInfo = '';
                        let actionButton = '';
                        
                        if (booking.status === 'cancelled') {
                            statusBadge = '<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full text-xs">Cancelled</span>';
                            
                            if (booking.cancelledBy === currentUser.uid) {
                                cancellationInfo = '<p class="text-xs text-gray-500 italic mt-1">You cancelled this booking</p>';
                            } else {
                                cancellationInfo = `<p class="text-xs text-gray-500 italic mt-1">Cancelled by ${booking.cancelledByName || 'the parent'}</p>`;
                            }
                            
                            actionButton = `<button class="remove-booking-btn mt-2 text-xs px-2 py-1 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300" data-booking-id="${booking.id}">
                                <i class="fas fa-times"></i> Remove
                            </button>`;
                        } else {
                            // For confirmed bookings, show cancel button
                            actionButton = `<button class="cancel-confirmed-btn mt-2 text-xs px-2 py-1 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-booking-id="${booking.id}">
                                Cancel Booking
                            </button>`;
                        }
                        
                        bookingEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${formattedDate}</p>
                                    <p>with ${booking.parentName}</p>
                                    ${cancellationInfo}
                                </div>
                                <div class="flex items-center">
                                    ${statusBadge}
                                </div>
                            </div>
                            <div class="flex justify-end">
                                ${actionButton}
                            </div>
                        `;
                        
                        confirmedBookingsEl.appendChild(bookingEl);
                        
                        // Add event listeners for buttons DIRECTLY to avoid issues
                        if (booking.status === 'cancelled') {
                            const removeBtn = bookingEl.querySelector('.remove-booking-btn');
                            if (removeBtn) {
                                removeBtn.addEventListener('click', () => {
                                    console.log("Remove button clicked for booking:", booking.id);
                                    removeDeclinedBooking(booking.id);
                                });
                            }
                        } else {
                            const cancelBtn = bookingEl.querySelector('.cancel-confirmed-btn');
                            if (cancelBtn) {
                                cancelBtn.addEventListener('click', () => {
                                    showConfirmationPopup(
                                        "Cancel Confirmed Booking",
                                        `Are you sure you want to cancel your booking with ${booking.parentName} on ${formattedDate}? This action cannot be undone.`,
                                        () => cancelSitterBooking(booking.id)
                                    );
                                });
                            }
                        }
                    } catch (dateError) {
                        console.error("Error formatting date for booking:", dateError);
                        // Skip this booking if date is invalid
                    }
                });
            } catch (error) {
                console.error("Error loading confirmed bookings:", error);
                console.error("Error stack:", error.stack);
                confirmedBookingsEl.innerHTML = '<p class="text-red-500">Error loading bookings. Please try again.</p>';
            }
        }

        // Add function to show cancellation notification if not already defined
        function showCancellationNotification(booking) {
            const notificationArea = document.getElementById('notification-area');
            const messageEl = document.getElementById('notification-message');
            const detailsEl = document.getElementById('notification-details');
            const dismissBtn = document.getElementById('dismiss-notification');
            
            try {
                // Format date
                const [year, month, day] = booking.date.split('-').map(Number);
                const bookingDate = new Date(year, month - 1, day);
                const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric'
                });
                
                // Set notification content
                messageEl.textContent = "Booking Cancelled!";
                detailsEl.textContent = `${booking.cancelledByName} cancelled your booking for ${formattedDate}.`;
                
                // Show notification
                notificationArea.classList.remove('hidden');
                
                // Set up dismiss button
                dismissBtn.addEventListener('click', () => {
                    notificationArea.classList.add('hidden');
                });
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    notificationArea.classList.add('hidden');
                }, 10000);
            } catch (error) {
                console.error("Error showing cancellation notification:", error);
            }
        }

        async function updateBookingStatus(bookingId, status) {
            try {
                // Get booking details first
                const bookingDoc = await getDoc(doc(db, "bookings", bookingId));
                if (!bookingDoc.exists()) {
                    throw new Error("Booking not found");
                }
                
                const booking = bookingDoc.data();
                
                // Update booking status
                await updateDoc(doc(db, "bookings", bookingId), {
                    status: status
                });
                
                // Get parent details for email notification
                const parentDoc = await getDoc(doc(db, "users", booking.parentId));
                if (parentDoc.exists()) {
                    const parent = parentDoc.data();
                    
                    // Format date for email
                    const [year, month, day] = booking.date.split('-').map(Number);
                    const bookingDate = new Date(year, month - 1, day);
                    const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                        weekday: 'long',
                        month: 'long', 
                        day: 'numeric'
                    });
                    
                    // Send appropriate email based on status
                    try {
                        if (status === 'confirmed') {
                            await notifyParentOfAcceptedBooking(
                                parent.email,
                                parent.name,
                                userProfile.name,
                                formattedDate
                            );
                            console.log("Booking confirmation email sent to parent");
                        } else if (status === 'declined') {
                            await notifyParentOfDeclinedBooking(
                                parent.email,
                                parent.name,
                                userProfile.name,
                                formattedDate
                            );
                            console.log("Booking declined email sent to parent");
                        }
                    } catch (emailError) {
                        console.error("Error sending booking status email:", emailError);
                    }
                }
                
                // Reload booking requests
                loadBookingRequests();
                
                // Reload confirmed bookings if accepted
                if (status === 'confirmed') {
                    loadConfirmedBookings();
                    
                    // Reload calendar to show the booked date
                    const [year, month] = sitterMonthSelector.value.split('-').map(Number);
                    generateSitterCalendar(year, month);
                }
            } catch (error) {
                console.error("Error updating booking status:", error);
                alert("Failed to update booking status. Please try again.");
            }
        }

        // Load connection requests for sitter
        // Updated loadSitterConnectionRequests function
async function loadSitterConnectionRequests() {
    const connectionRequestsEl = document.getElementById('sitter-connection-requests');
    
    try {
        console.log("Loading connection requests for sitter:", currentUser.uid);
        
        // Query the connectionRequests collection for pending requests to this sitter
        const requestsQuery = query(
            collection(db, "connectionRequests"),
            where("sitterId", "==", currentUser.uid),
            where("status", "==", "pending")
        );
        
        console.log("Running connection requests query...");
        const requestsSnapshot = await getDocs(requestsQuery);
        console.log("Found", requestsSnapshot.size, "connection requests");
        
        if (requestsSnapshot.empty) {
            connectionRequestsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No pending connection requests</p>';
            return;
        }
        
        // Update UI
        connectionRequestsEl.innerHTML = '';
        
        requestsSnapshot.forEach(doc => {
            const request = doc.data();
            console.log("Connection request data:", request, "ID:", doc.id);
            
            const requestEl = document.createElement('div');
            requestEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
            
            requestEl.innerHTML = `
                <div>
                    <p class="font-medium">${request.parentName}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Wants to connect with you</p>
                    <div class="flex space-x-2 mt-2">
                        <button class="accept-connection-btn px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md text-xs" data-request-id="${doc.id}">
                            Accept
                        </button>
                        <button class="decline-connection-btn px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md text-xs" data-request-id="${doc.id}">
                            Decline
                        </button>
                    </div>
                </div>
            `;
            
            connectionRequestsEl.appendChild(requestEl);
            
            // Add event listeners
            const acceptBtn = requestEl.querySelector('.accept-connection-btn');
            acceptBtn.addEventListener('click', () => {
                console.log("Accept button clicked for request:", doc.id);
                respondToConnectionRequest(doc.id, true);
            });
            
            const declineBtn = requestEl.querySelector('.decline-connection-btn');
            declineBtn.addEventListener('click', () => {
                console.log("Decline button clicked for request:", doc.id);
                respondToConnectionRequest(doc.id, false);
            });
        });
    } catch (error) {
        console.error("Error loading connection requests:", error);
        console.error("Error stack:", error.stack);
        connectionRequestsEl.innerHTML = '<p class="text-red-500">Error loading connection requests. Please try again.</p>';
        alert("Error loading connection requests: " + error.message);
    }
}

// Inside respondToConnectionRequest function
async function respondToConnectionRequest(requestId, accept) {
    try {
        console.log(`Responding to connection request ${requestId}, Accept: ${accept}`);
        
        // Get request info from the connectionRequests collection
        console.log("Getting request document...");
        const requestDoc = await getDoc(doc(db, "connectionRequests", requestId));
        
        if (!requestDoc.exists()) {
            throw new Error("Request not found");
        }
        
        const request = requestDoc.data();
        console.log("Request data:", request);
        
        // Ensure we have a valid parent ID
        if (!request.parentId) {
            throw new Error("Invalid request data: parentId not found");
        }
        
        const parentId = request.parentId;
        console.log(`Parent ID: ${parentId}, Current user ID: ${currentUser.uid}`);
        
        // Get parent details for email notification
        const parentDoc = await getDoc(doc(db, "users", parentId));
        let parent = null;
        if (parentDoc.exists()) {
            parent = parentDoc.data();
        }
        
        if (accept) {
            console.log("Accepting connection request...");
            
            // Initialize connections array if needed
            if (!userProfile.connections) {
                userProfile.connections = [];
            }
            
            // Add to sitter's connections
            console.log("Updating sitter's connections...");
            const sitterRef = doc(db, "users", currentUser.uid);
            await updateDoc(sitterRef, {
                connections: arrayUnion(parentId)
            });
            
            // Update local user profile
            if (!userProfile.connections.includes(parentId)) {
                userProfile.connections.push(parentId);
            }
            
            // Update parent's connections
            console.log(`Getting parent document for ID: ${parentId}`);
            const parentRef = doc(db, "users", parentId);
            const parentDoc = await getDoc(parentRef);
            
            if (parentDoc.exists()) {
                console.log("Found parent document, updating connections...");
                await updateDoc(parentRef, {
                    connections: arrayUnion(currentUser.uid)
                });
            } else {
                console.warn("Parent document not found!");
            }
            
            // Update the request status to "accepted"
            console.log("Updating request status to accepted");
            const requestRef = doc(db, "connectionRequests", requestId);
            await updateDoc(requestRef, {
                status: "accepted",
                updatedAt: serverTimestamp()
            });
            
            // Send email notification to parent about accepted connection
            if (parent) {
                try {
                    await notifyOfAcceptedConnection(
                        parent.email,
                        parent.name,
                        userProfile.name
                    );
                    console.log("Connection accepted email sent to parent");
                } catch (emailError) {
                    console.error("Error sending connection accepted email:", emailError);
                }
            }
            
            console.log("Connection request accepted successfully!");
            alert("Connection request accepted successfully!");
        } else {
            // Update the request status to "declined"
            console.log("Declining connection request...");
            const requestRef = doc(db, "connectionRequests", requestId);
            await updateDoc(requestRef, {
                status: "declined",
                updatedAt: serverTimestamp()
            });
            
            alert("Connection request declined.");
        }
        
        // Reload connection requests
        loadSitterConnectionRequests();
        
        // Reload connected parents if accepted
        if (accept) {
            loadConnectedParents();
        }
    } catch (error) {
        console.error("Error responding to connection request:", error);
        console.error("Error stack:", error.stack);
        alert("Failed to process connection request: " + error.message);
    }
}

        // Load connected parents
        async function loadConnectedParents() {
            const connectedParentsEl = document.getElementById('connected-parents');
            
            try {
                // Get sitter's connections
                const connections = userProfile.connections || [];
                
                if (connections.length === 0) {
                    connectedParentsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No connected parents yet</p>';
                    return;
                }
                
                // Get parent details
                const connectedParents = [];
                
                for (const parentId of connections) {
                    const parentDoc = await getDoc(doc(db, "users", parentId));
                    if (parentDoc.exists()) {
                        connectedParents.push({
                            id: parentId,
                            ...parentDoc.data()
                        });
                    }
                }
                
                // Update UI
                connectedParentsEl.innerHTML = '';
                
                connectedParents.forEach(parent => {
                    const parentCard = document.createElement('div');
                    parentCard.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
                    
                    parentCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${parent.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    ${parent.kidsAges && parent.kidsAges.length > 0 ? 
                                        `Kids ages: ${parent.kidsAges.join(', ')}` : 
                                        'No kids ages provided'}
                                </p>
                            </div>
                            <div>
                                <button class="remove-connection-btn text-sm px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md" data-parent-id="${parent.id}">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                    
                    connectedParentsEl.appendChild(parentCard);
                    
                    // Add event listener for remove connection
                    const removeBtn = parentCard.querySelector('.remove-connection-btn');
                    removeBtn.addEventListener('click', () => removeParentConnection(parent.id));
                });
            } catch (error) {
                console.error("Error loading connected parents:", error);
                connectedParentsEl.innerHTML = '<p class="text-red-500">Error loading connections. Please try again.</p>';
            }
        }
        
        // Remove parent connection
        async function removeParentConnection(parentId) {
            try {
                // Remove from sitter's connections
                await updateDoc(doc(db, "users", currentUser.uid), {
                    connections: arrayRemove(parentId)
                });
                
                // Remove from parent's connections
                await updateDoc(doc(db, "users", parentId), {
                    connections: arrayRemove(currentUser.uid)
                });
                
                // Update local user profile
                userProfile.connections = userProfile.connections.filter(id => id !== parentId);
                
                // Reload connected parents
                loadConnectedParents();
                
            } catch (error) {
                console.error("Error removing parent connection:", error);
                alert("Failed to remove connection. Please try again.");
            }
        }
        
        // Load parent's connected sitters
        async function loadConnectedSitters() {
            const connectedSittersEl = document.getElementById('connected-sitters');
            
            try {
                // Get parent's connections
                const connections = userProfile.connections || [];
                
                if (connections.length === 0) {
                    connectedSittersEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No connected sitters yet</p>';
                    return;
                }
                
                // Get sitter details
                const connectedSitters = [];
                
                for (const sitterId of connections) {
                    const sitterDoc = await getDoc(doc(db, "users", sitterId));
                    if (sitterDoc.exists()) {
                        connectedSitters.push({
                            id: sitterId,
                            ...sitterDoc.data()
                        });
                    }
                }
                
                // Update UI
                connectedSittersEl.innerHTML = '';
                
                connectedSitters.forEach(sitter => {
                    const sitterCard = document.createElement('div');
                    sitterCard.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
                    
                    sitterCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${sitter.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Age: ${sitter.age} | Experience: ${sitter.experience} year${sitter.experience !== 1 ? 's' : ''}</p>
                            </div>
                            <div>
                                <button class="remove-connection-btn text-sm px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md" data-sitter-id="${sitter.id}">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                    
                    connectedSittersEl.appendChild(sitterCard);
                    
                    // Add event listener for remove connection
                    const removeBtn = sitterCard.querySelector('.remove-connection-btn');
                    removeBtn.addEventListener('click', () => removeConnection(sitter.id));
                });
            } catch (error) {
                console.error("Error loading connected sitters:", error);
                connectedSittersEl.innerHTML = '<p class="text-red-500">Error loading connections. Please try again.</p>';
            }
        }
        
        // Remove connection
        async function removeConnection(sitterId) {
            try {
                // Remove from parent's connections
                await updateDoc(doc(db, "users", currentUser.uid), {
                    connections: arrayRemove(sitterId)
                });
                
                // Remove from sitter's connections
                await updateDoc(doc(db, "users", sitterId), {
                    connections: arrayRemove(currentUser.uid)
                });
                
                // Update local user profile
                userProfile.connections = userProfile.connections.filter(id => id !== sitterId);
                
                // Reload connected sitters
                loadConnectedSitters();
                
                // Reload calendar as availability might have changed
                const [year, month] = monthSelector.value.split('-').map(Number);
                generateParentCalendar(year, month);
                
                // If a date was selected, reload available sitters
                if (selectedDate) {
                    loadAvailableSitters(selectedDate);
                }
            } catch (error) {
                console.error("Error removing connection:", error);
                alert("Failed to remove connection. Please try again.");
            }
        }
        
        // Load pending connection requests
       // Updated loadPendingConnections function
async function loadPendingConnections() {
    const pendingConnectionsEl = document.getElementById('pending-connections');
    
    try {
        // Query the connectionRequests collection for pending requests from this parent
        const pendingQuery = query(
            collection(db, "connectionRequests"),
            where("parentId", "==", currentUser.uid),
            where("status", "==", "pending")
        );
        
        const pendingSnapshot = await getDocs(pendingQuery);
        
        if (pendingSnapshot.empty) {
            pendingConnectionsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No pending connection requests</p>';
            return;
        }
        
        // Update UI
        pendingConnectionsEl.innerHTML = '';
        
        pendingSnapshot.forEach(doc => {
            const request = doc.data();
            const requestEl = document.createElement('div');
            requestEl.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
            
            requestEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium">${request.sitterName}</p>
                        <p class="text-xs text-amber-600">Waiting for approval</p>
                    </div>
                    <div>
                        <button class="cancel-request-btn text-sm px-3 py-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md" data-request-id="${doc.id}">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            pendingConnectionsEl.appendChild(requestEl);
            
            // Add event listener for cancel button
            const cancelBtn = requestEl.querySelector('.cancel-request-btn');
            cancelBtn.addEventListener('click', () => cancelConnectionRequest(doc.id));
        });
    } catch (error) {
        console.error("Error loading pending connections:", error);
        pendingConnectionsEl.innerHTML = '<p class="text-red-500">Error loading pending requests. Please try again.</p>';
    }
}

        // Find Sitters function
        async function findSitters() {
            const searchInput = document.getElementById('sitter-name-search').value.trim();
            const resultsContainer = document.getElementById('sitter-search-results');
            
            if (!searchInput) {
                resultsContainer.innerHTML = '<p class="text-amber-600 dark:text-amber-400">Please enter a name to search for sitters</p>';
                return;
            }
            
            // Show loading state
            resultsContainer.innerHTML = '<p class="text-center py-4"><span class="loader" style="width: 24px; height: 24px;"></span></p>';
            
            try {
                // Query sitters by name (case insensitive)
                const searchTerm = searchInput.toLowerCase();
                const sittersQuery = query(collection(db, "users"), where("userType", "==", "sitter"));
                const snapshot = await getDocs(sittersQuery);
                
                // Get current user's connections and connection requests
                const connections = userProfile.connections || [];
                const connectionRequests = userProfile.connectionRequests || [];
                
                const matchingSitters = [];
                
                snapshot.forEach(doc => {
                    const sitter = doc.data();
                    if (sitter.name.toLowerCase().includes(searchTerm)) {
                        const sitterId = doc.id;
                        matchingSitters.push({
                            id: sitterId,
                            ...sitter,
                            isConnected: connections.includes(sitterId),
                            isPending: connectionRequests.some(req => req.userId === sitterId && req.status === 'outgoing')
                        });
                    }
                });
                
                // Display results
                if (matchingSitters.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No sitters found with that name</p>';
                } else {
                    resultsContainer.innerHTML = '';
                    
                    matchingSitters.forEach(sitter => {
                        const sitterCard = document.createElement('div');
                        sitterCard.className = 'bg-white dark:bg-gray-800 rounded-md shadow p-3 transition-all hover:shadow-md';
                        
                        let actionButton = '';
                        
                        if (sitter.isConnected) {
                            actionButton = `<span class="text-sm px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full">Connected</span>`;
                        } else if (sitter.isPending) {
                            actionButton = `<span class="text-sm px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-full">Request Sent</span>`;
                        } else {
                            actionButton = `<button class="connect-btn text-sm px-3 py-1 bg-primary-light hover:bg-opacity-90 dark:bg-primary-dark text-white rounded-md" data-sitter-id="${sitter.id}">Connect</button>`;
                        }
                        
                        sitterCard.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium">${sitter.name}</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-300">Age: ${sitter.age} | Experience: ${sitter.experience} year${sitter.experience !== 1 ? 's' : ''}</p>
                                </div>
                                <div>
                                    ${actionButton}
                                </div>
                            </div>
                        `;
                        
                        resultsContainer.appendChild(sitterCard);
                        
                        // Add event listeners for connect button
                        const connectBtn = sitterCard.querySelector('.connect-btn');
                        if (connectBtn) {
                            connectBtn.addEventListener('click', () => sendConnectionRequest(sitter.id));
                        }
                    });
                }
                
            } catch (error) {
                console.error("Error searching for sitters:", error);
                resultsContainer.innerHTML = '<p class="text-red-500">Error searching for sitters. Please try again.</p>';
            }
        }
        
        // Send connection request - Permission denied fix
       // Replace the sendConnectionRequest function with this version
        // Inside sendConnectionRequest function
async function sendConnectionRequest(sitterId) {
    try {
        // Get sitter info
        const sitterDoc = await getDoc(doc(db, "users", sitterId));
        if (!sitterDoc.exists()) {
            throw new Error("Sitter not found");
        }
        
        const sitter = sitterDoc.data();
        
        // Create a unique request in the connectionRequests collection
        const requestData = {
            parentId: currentUser.uid,
            parentName: userProfile.name,
            sitterId: sitterId,
            sitterName: sitter.name,
            status: 'pending',
            createdAt: serverTimestamp(),
        };
        
        // Check if a similar request already exists
        const existingRequestQuery = query(
            collection(db, "connectionRequests"),
            where("parentId", "==", currentUser.uid),
            where("sitterId", "==", sitterId),
            where("status", "==", "pending")
        );
        
        const existingSnapshot = await getDocs(existingRequestQuery);
        
        if (!existingSnapshot.empty) {
            // Show success message since it's already requested
            const resultsContainer = document.getElementById('sitter-search-results');
            resultsContainer.innerHTML = '<p class="text-green-500 mb-3">Connection request already sent!</p>' + resultsContainer.innerHTML;
            return;
        }
        
        // Add the request to the connectionRequests collection
        await addDoc(collection(db, "connectionRequests"), requestData);
        
        // Send email notification to sitter about connection request
        try {
            await notifyOfConnectionRequest(
                sitter.email,
                sitter.name,
                userProfile.name
            );
            console.log("Connection request email sent to sitter");
        } catch (emailError) {
            console.error("Error sending connection request email:", emailError);
        }
        
        // Show success message
        const resultsContainer = document.getElementById('sitter-search-results');
        resultsContainer.innerHTML = '<p class="text-green-500 mb-3">Connection request sent successfully!</p>' + resultsContainer.innerHTML;
        
        // Reload pending connections display
        loadPendingConnections();
    } catch (error) {
        console.error("Error sending connection request:", error);
        alert("Failed to send connection request: " + error.message);
    }
}

        // Show auth popup
        document.getElementById('show-login-btn').addEventListener('click', () => {
            document.getElementById('auth-popup').classList.remove('hidden');
        });

        // Close auth popup
        document.getElementById('close-auth-popup').addEventListener('click', () => {
            document.getElementById('auth-popup').classList.add('hidden');
        });

        // Add this code at the bottom of your script section
// This will add direct event listeners to debug and fix the issue

document.addEventListener("DOMContentLoaded", function() {
    // Get login form again to ensure it's found
    const loginFormDirect = document.getElementById('login-form');
    
    if (loginFormDirect) {
        console.log("Login form found");
        
        // Add direct submit listener
        loginFormDirect.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("Form submitted");
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                console.log("Attempting login with:", email);
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful");
                document.getElementById('auth-popup').classList.add('hidden');
            } catch (error) {
                console.error("Login error:", error);
                const loginError = document.getElementById('login-error');
                loginError.textContent = `Login failed: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        });
    } else {
        console.error("Login form not found in DOMContentLoaded");
    }
    
    // Also add a direct click handler on the button as backup
    const loginSubmitBtn = document.querySelector('#login-form button[type="submit"]');
    if (loginSubmitBtn) {
        loginSubmitBtn.addEventListener('click', function(e) {
            console.log("Login button clicked directly");
            // This will trigger the form's submit event
            const form = this.closest('form');
            if (form) form.dispatchEvent(new Event('submit'));
        });
    }
});

    // Add this code near your other DOM elements section
document.addEventListener("DOMContentLoaded", function() {
    // Fix the missing authContainer reference
    const authPopup = document.getElementById('auth-popup');
    
    // Update the auth state listener to use the correct element
    onAuthStateChanged(auth, async (user) => {
        console.log("Auth state changed:", user ? "logged in" : "logged out");
        // Hide loading screen
        loadingEl.classList.add('hidden');
        
        if (user) {
            // User is signed in
            currentUser = user;
            
            try {
                // Get user profile
                const userDoc = await getDoc(doc(db, "users", user.uid));
                console.log("User profile found:", userDoc.exists());
                
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                    
                    // Display user name
                    userNameDisplay.textContent = userProfile.name;
                    userNameDisplay.classList.remove('hidden');
                    
                    // Show appropriate dashboard
                    authPopup.classList.add('hidden'); // Use authPopup instead
                    document.getElementById('homepage-container').classList.add('hidden'); // Hide homepage
                    dashboardContainer.classList.remove('hidden');
                    
                    console.log("User type:", userProfile.userType);
                    
                    if (userProfile.userType === 'parent') {
                        parentDashboard.classList.remove('hidden');
                        sitterDashboard.classList.add('hidden');
                        setupParentDashboard();
                    } else {
                        sitterDashboard.classList.remove('hidden');
                        parentDashboard.classList.add('hidden');
                        setupSitterDashboard();
                    }
                } else {
                    console.error("User profile not found");
                    alert("User profile not found. Please try registering again.");
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                alert("Error loading profile: " + error.message);
            }
        } else {
            // User is signed out
            currentUser = null;
            userProfile = null;
            
            // Show homepage container
            document.getElementById('homepage-container').classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            parentDashboard.classList.add('hidden');
            sitterDashboard.classList.add('hidden');
            
            // Reset forms
            loginForm.reset();
            registerForm.reset();
        }
    });
});

        // Add this function to your script
        function setupResizableSplitter() {
            const splitter = document.getElementById('splitter');
            const calendarColumn = document.getElementById('calendar-column');
            const widgetsColumn = document.getElementById('widgets-column');
            const container = document.getElementById('resizable-container');
            
            // Add handle to splitter if it doesn't exist
            if (!splitter.querySelector('.handle')) {
                const handle = document.createElement('div');
                handle.className = 'handle';
                splitter.appendChild(handle);
            }
            
            let isResizing = false;
            let lastDownX = 0;
            
            // Add splitter functionality
            splitter.addEventListener('mousedown', (e) => {
                isResizing = true;
                lastDownX = e.clientX;
                
                // Add active class to splitter
                splitter.classList.add('active');
                
                // Add overlay to prevent text selection during resize
                const overlay = document.createElement('div');
                overlay.className = 'resize-overlay';
                document.body.appendChild(overlay);
                
                // Store initial widths
                splitter.dataset.initialCalendarWidth = calendarColumn.offsetWidth;
                splitter.dataset.initialWidgetsWidth = widgetsColumn.offsetWidth;
                splitter.dataset.initialContainerWidth = container.offsetWidth;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const deltaX = e.clientX - lastDownX;
                const initialCalendarWidth = parseInt(splitter.dataset.initialCalendarWidth);
                const initialWidgetsWidth = parseInt(splitter.dataset.initialWidgetsWidth);
                const containerWidth = parseInt(splitter.dataset.initialContainerWidth);
                
                const newCalendarWidth = initialCalendarWidth + deltaX;
                const newWidgetsWidth = initialWidgetsWidth - deltaX;
                
                // Set minimum widths
                if (newCalendarWidth > 300 && newWidgetsWidth > 300) {
                    const calendarPercent = (newCalendarWidth / containerWidth) * 100;
                    const widgetsPercent = (newWidgetsWidth / containerWidth) * 100;
                    
                    calendarColumn.style.width = `${calendarPercent}%`;
                    widgetsColumn.style.width = `${widgetsPercent}%`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    splitter.classList.remove('active');
                    
                    // Remove overlay
                    const overlay = document.querySelector('.resize-overlay');
                    if (overlay) {
                        document.body.removeChild(overlay);
                    }
                }
            });
            
            // Also handle touch events for mobile
            splitter.addEventListener('touchstart', (e) => {
                isResizing = true;
                lastDownX = e.touches[0].clientX;
                
                // Store initial widths
                splitter.dataset.initialCalendarWidth = calendarColumn.offsetWidth;
                splitter.dataset.initialWidgetsWidth = widgetsColumn.offsetWidth;
                splitter.dataset.initialContainerWidth = container.offsetWidth;
                
                e.preventDefault();
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isResizing) return;
                
                const deltaX = e.touches[0].clientX - lastDownX;
                const initialCalendarWidth = parseInt(splitter.dataset.initialCalendarWidth);
                const initialWidgetsWidth = parseInt(splitter.dataset.initialWidgetsWidth);
                const containerWidth = parseInt(splitter.dataset.initialContainerWidth);
                
                const newCalendarWidth = initialCalendarWidth + deltaX;
                const newWidgetsWidth = initialWidgetsWidth - deltaX;
                
                // Set minimum widths
                if (newCalendarWidth > 300 && newWidgetsWidth > 300) {
                    const calendarPercent = (newCalendarWidth / containerWidth) * 100;
                    const widgetsPercent = (newWidgetsWidth / containerWidth) * 100;
                    
                    calendarColumn.style.width = `${calendarPercent}%`;
                    widgetsColumn.style.width = `${widgetsPercent}%`;
                }
                
                e.preventDefault();
            });
            
            document.addEventListener('touchend', () => {
                isResizing = false;
            });
        }

        // Add these functions for the confirmation popup
        function showConfirmationPopup(title, message, onConfirm) {
            try {
                const popup = document.getElementById('confirmation-popup');
                if (!popup) {
                    console.error("Confirmation popup element not found");
                    // Fallback to simple confirm dialog
                    if (confirm(message)) {
                        onConfirm();
                    }
                    return;
                }
                
                const titleEl = document.getElementById('confirmation-title');
                const messageEl = document.getElementById('confirmation-message');
                const confirmBtn = document.getElementById('confirm-cancel-btn');
                const cancelBtn = document.getElementById('cancel-action-btn');
                
                // Set content
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Clear any existing event listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                // Show popup
                popup.classList.remove('hidden');
                
                // Handle button clicks
                newConfirmBtn.addEventListener('click', () => {
                    onConfirm();
                    popup.classList.add('hidden');
                });
                
                newCancelBtn.addEventListener('click', () => {
                    popup.classList.add('hidden');
                });
            } catch (error) {
                console.error("Error showing confirmation popup:", error);
                // Fallback to simple confirm dialog
                if (confirm(message)) {
                    onConfirm();
                }
            }
        }

        // Fix the cancelSitterBooking function to handle errors better
        // Inside cancelSitterBooking function
async function cancelSitterBooking(bookingId) {
    try {
        // Get booking details first
        const bookingDoc = await getDoc(doc(db, "bookings", bookingId));
        if (!bookingDoc.exists()) {
            throw new Error("Booking not found");
        }
        
        const booking = bookingDoc.data();
        
        // Update booking to cancelled status
        await updateDoc(doc(db, "bookings", bookingId), {
            status: 'cancelled',
            cancelledBy: currentUser.uid,
            cancelledAt: serverTimestamp(),
            cancelledByName: userProfile.name,
            wasNotified: false
        });
        
        // Get parent details for email notification
        const parentDoc = await getDoc(doc(db, "users", booking.parentId));
        if (parentDoc.exists()) {
            const parent = parentDoc.data();
            
            // Format date for email
            const [year, month, day] = booking.date.split('-').map(Number);
            const bookingDate = new Date(year, month - 1, day);
            const formattedDate = bookingDate.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric'
            });
            
            // Send cancellation email to parent
            try {
                await notifyParentOfCancelledBooking(
                    parent.email,
                    parent.name,
                    userProfile.name,
                    formattedDate
                );
                console.log("Booking cancellation email sent to parent");
            } catch (emailError) {
                console.error("Error sending cancellation email:", emailError);
            }
        }
        
        // Display success message
        alert("Booking has been cancelled successfully.");
        
        // Reload confirmed bookings
        loadConfirmedBookings();
        
        // Reload calendar to update availability UI
        try {
            const [year, month] = sitterMonthSelector.value.split('-').map(Number);
            generateSitterCalendar(year, month);
        } catch (calendarError) {
            console.error("Error updating calendar:", calendarError);
        }
    } catch (error) {
        console.error("Error canceling booking:", error);
        alert("Failed to cancel booking. Please try again.");
    }
}

        // Replace DOMContentLoaded handlers with safer versions
        // We'll consolidate the two separate handlers to avoid conflicts
        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOMContentLoaded: Setting up event handlers");
            try {
                // Fix the missing authContainer reference
                const authPopup = document.getElementById('auth-popup');
                
                // Get login form again to ensure it's found
                const loginFormDirect = document.getElementById('login-form');
                
                if (loginFormDirect) {
                    console.log("Login form found");
                    
                    // Add direct submit listener
                    loginFormDirect.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log("Form submitted");
                        
                        const email = document.getElementById('login-email').value;
                        const password = document.getElementById('login-password').value;
                        
                        try {
                            console.log("Attempting login with:", email);
                            await signInWithEmailAndPassword(auth, email, password);
                            console.log("Login successful");
                            document.getElementById('auth-popup').classList.add('hidden');
                        } catch (error) {
                            console.error("Login error:", error);
                            const loginError = document.getElementById('login-error');
                            loginError.textContent = `Login failed: ${error.message}`;
                            loginError.classList.remove('hidden');
                        }
                    });
                } else {
                    console.error("Login form not found in DOMContentLoaded");
                }
                
                // Also add a direct click handler on the button as backup
                const loginSubmitBtn = document.querySelector('#login-form button[type="submit"]');
                if (loginSubmitBtn) {
                    loginSubmitBtn.addEventListener('click', function(e) {
                        console.log("Login button clicked directly");
                        // This will trigger the form's submit event
                        const form = this.closest('form');
                        if (form) form.dispatchEvent(new Event('submit'));
                    });
                }
                
                // Check if elements for cancel booking functionality exist before setting up related code
                const confirmationPopup = document.getElementById('confirmation-popup');
                if (!confirmationPopup) {
                    console.warn("Confirmation popup not found in DOM");
                }
                
                console.log("DOMContentLoaded setup completed successfully");
            } catch (error) {
                console.error("Error in DOMContentLoaded setup:", error);
            }
        });

        // Ensure auth state change handler has proper error handling 
        onAuthStateChanged(auth, async (user) => {
            try {
                console.log("Auth state changed:", user ? "logged in" : "logged out");
                // Hide loading screen
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.classList.add('hidden');
                }
                
                if (user) {
                    // User is signed in
                    currentUser = user;
                    
                    try {
                        // Get user profile
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        console.log("User profile found:", userDoc.exists());
                        
                        if (userDoc.exists()) {
                            userProfile = userDoc.data();
                            
                            // Display user name
                            if (userNameDisplay) {
                                userNameDisplay.textContent = userProfile.name;
                                userNameDisplay.classList.remove('hidden');
                            }
                            
                            // Show appropriate dashboard
                            const authPopup = document.getElementById('auth-popup');
                            const homepageContainer = document.getElementById('homepage-container');
                            
                            if (authPopup) authPopup.classList.add('hidden');
                            if (homepageContainer) homepageContainer.classList.add('hidden');
                            if (dashboardContainer) dashboardContainer.classList.remove('hidden');
                            
                            console.log("User type:", userProfile.userType);
                            
                            if (userProfile.userType === 'parent') {
                                if (parentDashboard) parentDashboard.classList.remove('hidden');
                                if (sitterDashboard) sitterDashboard.classList.add('hidden');
                                setupParentDashboard();
                            } else {
                                if (sitterDashboard) sitterDashboard.classList.remove('hidden');
                                if (parentDashboard) parentDashboard.classList.add('hidden');
                                setupSitterDashboard();
                            }
                        } else {
                            console.error("User profile not found");
                            alert("User profile not found. Please try registering again.");
                        }
                    } catch (error) {
                        console.error("Error fetching user profile:", error);
                        alert("Error loading profile: " + error.message);
                    }
                } else {
                    // User is signed out
                    currentUser = null;
                    userProfile = null;
                    
                    // Show homepage container
                    const homepageContainer = document.getElementById('homepage-container');
                    if (homepageContainer) homepageContainer.classList.remove('hidden');
                    if (dashboardContainer) dashboardContainer.classList.add('hidden');
                    if (parentDashboard) parentDashboard.classList.add('hidden');
                    if (sitterDashboard) sitterDashboard.classList.add('hidden');
                    
                    // Reset forms
                    if (loginForm) loginForm.reset();
                    if (registerForm) registerForm.reset();
                }
            } catch (error) {
                // Critical error handler - make sure we at least stop showing loading spinner
                console.error("Critical error in auth state change:", error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.classList.add('hidden');
                }
                
                // Show homepage as fallback
                const homepageContainer = document.getElementById('homepage-container');
                if (homepageContainer) {
                    homepageContainer.classList.remove('hidden');
                }
                
                alert("There was a problem loading the application. Please refresh the page and try again.");
            }
        });

        // To send a welcome email:
        await window.BabysitBuddyEmails.sendWelcomeEmail(user.email, user.name);

        // To send a booking request notification:
        await window.BabysitBuddyEmails.sendBookingRequestToSitter(
            sitterEmail, 
            sitterName,
            parentName,
            bookingDate
        );

        // To use any other email function directly:
        await window.BabysitBuddyEmails.notifyParentOfAcceptedBooking(
            parentEmail, 
            parentName,
            sitterName,
            bookingDate
        );

    </script>
    <script>
        // Add these new functions

        // Variables to store booking information
        let currentBookingSitter = null;
        let currentBookingDate = null;
        let selectedTimeRange = null;

        // Show booking modal with time slots
        function showBookingModal(sitter, date) {
            currentBookingSitter = sitter;
            currentBookingDate = date;
            selectedTimeRange = null;
            
            const modal = document.getElementById('booking-time-slot-modal');
            const dateHeader = document.getElementById('booking-modal-date');
            const sitterInfo = document.getElementById('booking-sitter-info');
            const slotsContainer = document.getElementById('booking-time-slots');
            const notesField = document.getElementById('booking-notes');
            const confirmBtn = document.getElementById('confirm-booking-btn');
            
            // Reset form
            notesField.value = '';
            confirmBtn.disabled = true;
            
            // Format date for display
            const [year, month, day] = date.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric'
            });
            
            // Set header content
            dateHeader.textContent = `Book ${sitter.name} for ${formattedDate}`;
            sitterInfo.textContent = `Select from ${sitter.name}'s available time windows:`;
            
            // Transform time slots to HTML
            if (sitter.timeSlots && sitter.timeSlots.length > 0) {
                slotsContainer.innerHTML = '';
                
                // Create a custom time selector div
                const customSelectorDiv = document.createElement('div');
                customSelectorDiv.className = 'w-full mb-4';
                
                // Show available time windows
                customSelectorDiv.innerHTML = `
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">Available time windows:</label>
                        <ul class="text-sm text-gray-600 dark:text-gray-300 pl-4">
                            ${sitter.timeSlots.map(slot => {
                                const formatTime = (timeStr) => {
                                    const [hours, minutes] = timeStr.split(':').map(Number);
                                    const period = hours >= 12 ? 'PM' : 'AM';
                                    const displayHours = hours % 12 || 12;
                                    return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
                                };
                                return `<li class="mb-1">${formatTime(slot.start)} - ${formatTime(slot.end)}</li>`;
                            }).join('')}
                        </ul>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">Start time</label>
                            <input type="time" id="booking-start-time" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">End time</label>
                            <input type="time" id="booking-end-time" class="w-full px-3 py-2 text-base border rounded-md focus:outline-none focus:ring-2 focus:ring-primary-light dark:bg-gray-800 dark:border-gray-700">
                        </div>
                    </div>
                    <p id="time-validation-message" class="text-xs text-red-500 hidden">Please select times within the sitter's available hours.</p>
                `;
                
                slotsContainer.appendChild(customSelectorDiv);
                
                // Add time validation
                const startTimeInput = document.getElementById('booking-start-time');
                const endTimeInput = document.getElementById('booking-end-time');
                const validationMessage = document.getElementById('time-validation-message');
                
                const validateTimeSelection = () => {
                    const start = startTimeInput.value;
                    const end = endTimeInput.value;
                    
                    if (!start || !end) {
                        confirmBtn.disabled = true;
                        validationMessage.classList.add('hidden');
                        return;
                    }
                    
                    // Check if time selection is valid (falls within one of the available slots)
                    let isValid = false;
                    for (const slot of sitter.timeSlots) {
                        if (isTimeWithinSlot(start, end, slot.start, slot.end)) {
                            isValid = true;
                            break;
                        }
                    }
                    
                    if (isValid) {
                        confirmBtn.disabled = false;
                        validationMessage.classList.add('hidden');
                        selectedTimeRange = { start, end };
                        // Add debug indication that time selection is valid
                        console.log("Valid time selected:", selectedTimeRange);
                    } else {
                        confirmBtn.disabled = true;
                        validationMessage.classList.remove('hidden');
                        selectedTimeRange = null;
                    }
                };
                
                startTimeInput.addEventListener('change', validateTimeSelection);
                endTimeInput.addEventListener('change', validateTimeSelection);
                
            } else {
                slotsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No available time slots specified for this day.</p>';
            }
            
            // Show the modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Helper function to check if selected time is within an available slot
        function isTimeWithinSlot(selectedStart, selectedEnd, slotStart, slotEnd) {
            // Convert to minutes for comparison
            const toMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            const selectedStartMins = toMinutes(selectedStart);
            const selectedEndMins = toMinutes(selectedEnd);
            const slotStartMins = toMinutes(slotStart);
            const slotEndMins = toMinutes(slotEnd);
            
            // Check if selection is valid (non-zero duration and within slot)
            return (
                selectedStartMins < selectedEndMins && 
                selectedStartMins >= slotStartMins && 
                selectedEndMins <= slotEndMins
            );
        }

        // Set up booking modal event handlers
        // Replace the setupBookingModal function with this improved version
function setupBookingModal() {
    console.log("Setting up booking modal");
    const modal = document.getElementById('booking-time-slot-modal');
    const closeBtn = document.getElementById('close-booking-modal');
    const confirmBtn = document.getElementById('confirm-booking-btn');
    
    console.log("Modal elements:", modal ? "found" : "not found", 
                "| Close button:", closeBtn ? "found" : "not found", 
                "| Confirm button:", confirmBtn ? "found" : "not found");
    
    // Remove any existing event listeners by cloning and replacing the buttons
    if (closeBtn) {
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
        
        newCloseBtn.addEventListener('click', () => {
            console.log("Close button clicked");
            modal.classList.add('hidden');
            document.body.style.overflow = ''; // Re-enable scrolling
        });
    }
    
    // Handle confirm button the same way
    if (confirmBtn) {
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', async () => {
            console.log("Confirm button clicked, selectedTimeRange:", selectedTimeRange);
            
            if (!selectedTimeRange) {
                alert("Please select a valid time range.");
                return;
            }
            
            try {
                // Add click animation
                newConfirmBtn.classList.add('scale-95', 'opacity-75');
                setTimeout(() => {
                    newConfirmBtn.classList.remove('scale-95', 'opacity-75');
                }, 150);
                
                console.log("Calling bookSitterWithTimeSlot");
                await bookSitterWithTimeSlot();
                
                // Close modal
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Re-enable scrolling
            } catch (error) {
                console.error("Error in confirm booking handler:", error);
                alert("There was an error processing your booking. Please try again.");
            }
        });
    }
    
    console.log("Booking modal setup complete");
}


        // Book sitter with selected time slot
        async function bookSitterWithTimeSlot() {
            try {
                // Ensure we have access to the global variables
                const user = window.currentUser || currentUser;
                const profile = window.userProfile || userProfile;
                const timeRange = window.selectedTimeRange || selectedTimeRange;
                
                console.log("Current user:", user);
                console.log("User profile:", profile);
                console.log("Selected time range:", timeRange);
                
                if (!user || !user.uid) {
                    throw new Error("User not authenticated");
                }
                
                if (!currentBookingSitter || !currentBookingDate) {
                    throw new Error("Booking information missing");
                }
                
                const notes = document.getElementById('booking-notes').value.trim();
                
                // Create booking request with time slot and notes
                const booking = {
                    parentId: user.uid,
                    sitterId: currentBookingSitter.id,
                    date: currentBookingDate,
                    timeSlot: timeRange,
                    notes: notes,
                    status: 'pending',
                    createdAt: serverTimestamp()
                };
                
                console.log("Creating booking:", booking);
                
                // Add booking to Firestore
                const db = firebase.firestore();
                await addDoc(collection(db, "bookings"), booking);
                
                console.log("Booking created successfully");
                
                // Show success message
                if (typeof window.showNotification === 'function') {
                    window.showNotification("Success", "Booking request sent successfully!", "green");
                } else {
                    alert("Booking request sent successfully!");
                }
                
                // Close modal
                const modal = document.getElementById('booking-time-slot-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
                
                // Reload relevant data
                if (typeof loadAvailableSitters === 'function') {
                    loadAvailableSitters(currentBookingDate);
                }
                
                if (typeof loadUpcomingBookings === 'function') {
                    loadUpcomingBookings();
                }
                
                return true;
            } catch (error) {
                console.error("Error booking sitter:", error);
                
                // Show error message
                if (typeof window.showNotification === 'function') {
                    window.showNotification("Error", "Failed to book sitter: " + error.message, "red");
                } else {
                    alert("Failed to book sitter: " + error.message);
                }
                
                return false;
            }
        }

        // Also update the notifySitterOfBookingRequest function in your email integration file
        // This would need a corresponding update in your backend email functionality
    </script>
    <script>
        // Add this to your existing DOMContentLoaded event handler or create a new one
        document.addEventListener("DOMContentLoaded", function() {
            // Direct event handler for the confirm booking button
            document.body.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'confirm-booking-btn') {
                    console.log("Confirm button clicked through direct body listener");
                    if (!selectedTimeRange) {
                        alert("Please select a valid time range.");
                        return;
                    }
                    
                    bookSitterWithTimeSlot()
                        .then(() => {
                            const modal = document.getElementById('booking-time-slot-modal');
                            modal.classList.add('hidden');
                            document.body.style.overflow = '';
                        })
                        .catch(error => {
                            console.error("Error in booking:", error);
                        });
                }
            });
        });
    </script>
    <script>
        // Add this at the beginning of your last script tag to ensure variables are shared between scripts
        window.currentUser = currentUser;
        window.userProfile = userProfile;
        window.selectedTimeRange = selectedTimeRange;
        window.bookSitterWithTimeSlot = bookSitterWithTimeSlot;
        window.serverTimestamp = serverTimestamp;
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
    </script>
    <script>
        // Add this function if missing
        window.showNotification = function(title, message, type = "green") {
            const notificationArea = document.getElementById('notification-area');
            if (!notificationArea) {
                console.error("Notification area not found");
                alert(title + ": " + message);
                return;
            }
            
            // Get or create elements if they don't exist
            let messageEl = document.getElementById('notification-message');
            let detailsEl = document.getElementById('notification-details');
            let dismissBtn = document.getElementById('dismiss-notification');
            
            if (!messageEl || !detailsEl) {
                // Create the notification content if it doesn't exist
                notificationArea.innerHTML = `
                    <div class="bg-${type}-100 border-l-4 border-${type}-500 text-${type}-700 p-4 rounded shadow-lg slide-in">
                        <div class="flex">
                            <div class="py-1"><svg class="fill-current h-6 w-6 text-${type}-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/></svg></div>
                            <div>
                                <p id="notification-message" class="font-bold">${title}</p>
                                <p id="notification-details" class="text-sm">${message}</p>
                            </div>
                            <div class="ml-auto">
                                <button id="dismiss-notification" class="bg-${type}-500 hover:bg-${type}-600 text-white rounded-full w-6 h-6 flex items-center justify-center"></button>
                            </div>
                        </div>
                    </div>
                `;
                
                messageEl = document.getElementById('notification-message');
                detailsEl = document.getElementById('notification-details');
                dismissBtn = document.getElementById('dismiss-notification');
            } else {
                // Just update the existing elements
                messageEl.textContent = title;
                detailsEl.textContent = message;
            }
            
            // Show notification
            notificationArea.classList.remove('hidden');
            
            // Set up dismiss button
            if (dismissBtn) {
                const newDismissBtn = dismissBtn.cloneNode(true);
                dismissBtn.parentNode.replaceChild(newDismissBtn, dismissBtn);
                newDismissBtn.addEventListener('click', () => {
                    notificationArea.classList.add('hidden');
                });
            }
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                notificationArea.classList.add('hidden');
            }, 5000);
        }
    </script>
    <script>
        // Add this right after your other script tag
        document.addEventListener("DOMContentLoaded", function() {
            document.body.addEventListener('click', async function(e) {
                if (e.target && e.target.id === 'confirm-booking-btn') {
                    console.log("Confirm button clicked with direct handler");
                    
                    // Get required data directly
                    const modal = document.getElementById('booking-time-slot-modal');
                    const startTimeInput = document.getElementById('booking-start-time');
                    const endTimeInput = document.getElementById('booking-end-time');
                    const notesField = document.getElementById('booking-notes');
                    
                    if (!startTimeInput || !startTimeInput.value || !endTimeInput || !endTimeInput.value) {
                        alert("Please select a valid time range");
                        return;
                    }
                    
                    try {
                        // Create booking directly
                        const db = firebase.firestore();
                        
                        await db.collection("bookings").add({
                            parentId: firebase.auth().currentUser.uid,
                            sitterId: window.currentBookingSitter.id,
                            date: window.currentBookingDate,
                            timeSlot: {
                                start: startTimeInput.value,
                                end: endTimeInput.value
                            },
                            notes: notesField.value.trim(),
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Success handling
                        alert("Booking request sent successfully!");
                        modal.classList.add('hidden');
                        document.body.style.overflow = '';
                        
                        // Reload data if functions available
                        if (typeof loadAvailableSitters === 'function') {
                            loadAvailableSitters(window.currentBookingDate);
                        }
                        
                        if (typeof loadUpcomingBookings === 'function') {
                            loadUpcomingBookings();
                        }
                    } catch (error) {
                        console.error("Error in direct booking handler:", error);
                        alert("There was an error processing your booking: " + error.message);
                    }
                }
            });
        });
    </script>
    <script>
        // Fix for direct booking handler
document.addEventListener("DOMContentLoaded", function() {
    document.body.addEventListener('click', async function(e) {
        if (e.target && e.target.id === 'confirm-booking-btn') {
            console.log("Confirm button clicked with direct handler");
            
            // Get required data directly
            const modal = document.getElementById('booking-time-slot-modal');
            const startTimeInput = document.getElementById('booking-start-time');
            const endTimeInput = document.getElementById('booking-end-time');
            const notesField = document.getElementById('booking-notes');
            
            if (!startTimeInput || !startTimeInput.value || !endTimeInput || !endTimeInput.value) {
                alert("Please select a valid time range");
                return;
            }
            
            try {
                // Use the imported db and serverTimestamp functions
                // These are available from your main script module imports
                console.log("Creating booking with db:", window.currentBookingSitter);
                
                const bookingData = {
                    parentId: auth.currentUser.uid,
                    sitterId: window.currentBookingSitter.id,
                    date: window.currentBookingDate,
                    timeSlot: {
                        start: startTimeInput.value,
                        end: endTimeInput.value
                    },
                    notes: notesField.value.trim(),
                    status: 'pending',
                    createdAt: serverTimestamp()
                };
                
                console.log("Booking data:", bookingData);
                await addDoc(collection(db, "bookings"), bookingData);
                
                // Success handling
                alert("Booking request sent successfully!");
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                
                // Reload data if functions available
                if (typeof loadAvailableSitters === 'function') {
                    loadAvailableSitters(window.currentBookingDate);
                }
                
                if (typeof loadUpcomingBookings === 'function') {
                    loadUpcomingBookings();
                }
            } catch (error) {
                console.error("Error in direct booking handler:", error);
                alert("There was an error processing your booking: " + error.message);
            }
        }
    });
});
    </script>
    <script>
        // Expose Firebase objects and current state globally - add this right after your Firebase module imports
    document.addEventListener("DOMContentLoaded", function() {
        // Make sure all form handlers are set up
        setupBookingModal();
        
        // Create a window-level object to store all Firebase objects and state
        window.BabysitBuddy = {};
        
        // Check for Firebase setup completion
        const checkFirebaseInterval = setInterval(function() {
            if (typeof getAuth !== 'undefined' && typeof getFirestore !== 'undefined') {
                // Store Firebase objects
                window.BabysitBuddy.auth = getAuth();
                window.BabysitBuddy.db = getFirestore();
                window.BabysitBuddy.addDoc = addDoc;
                window.BabysitBuddy.collection = collection;
                window.BabysitBuddy.serverTimestamp = serverTimestamp;
                
                // Clear the interval once we've successfully initialized
                clearInterval(checkFirebaseInterval);
                console.log("Firebase objects exposed to global scope");
            }
        }, 100);
    });
    
    // Fix for bookSitterWithTimeSlot function 
    async function bookSitterWithTimeSlot() {
        try {
            // Access Firebase objects from our global store
            const auth = window.BabysitBuddy.auth;
            const db = window.BabysitBuddy.db;
            const user = auth.currentUser;
            
            console.log("Current user from auth:", user);
            
            if (!user || !user.uid) {
                throw new Error("User not authenticated");
            }
            
            if (!window.currentBookingSitter || !window.currentBookingDate) {
                throw new Error("Booking information missing");
            }
            
            const notes = document.getElementById('booking-notes').value.trim();
            
            // Create booking request with time slot and notes
            const booking = {
                parentId: user.uid,
                sitterId: window.currentBookingSitter.id,
                date: window.currentBookingDate,
                timeSlot: {
                    start: document.getElementById('booking-start-time').value,
                    end: document.getElementById('booking-end-time').value
                },
                notes: notes,
                status: 'pending',
                createdAt: window.BabysitBuddy.serverTimestamp()
            };
            
            console.log("Creating booking:", booking);
            
            // Add booking to Firestore
            await window.BabysitBuddy.addDoc(
                window.BabysitBuddy.collection(db, "bookings"), 
                booking
            );
            
            console.log("Booking created successfully");
            
            // Show success message
            if (typeof window.showNotification === 'function') {
                window.showNotification("Success", "Booking request sent successfully!", "green");
            } else {
                alert("Booking request sent successfully!");
            }
            
            // Close modal
            const modal = document.getElementById('booking-time-slot-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // Reload relevant data
            if (typeof loadAvailableSitters === 'function') {
                loadAvailableSitters(window.currentBookingDate);
            }
            
            if (typeof loadUpcomingBookings === 'function') {
                loadUpcomingBookings();
            }
            
            return true;
        } catch (error) {
            console.error("Error booking sitter:", error);
            
            // Show error message
            if (typeof window.showNotification === 'function') {
                window.showNotification("Error", "Failed to book sitter: " + error.message, "red");
            } else {
                alert("Failed to book sitter: " + error.message);
            }
            
            return false;
        }
    }

    // Fix for direct booking handler
    document.addEventListener("DOMContentLoaded", function() {
        document.body.addEventListener('click', async function(e) {
            if (e.target && e.target.id === 'confirm-booking-btn') {
                console.log("Confirm button clicked with direct handler");
                
                // Get required data directly
                const modal = document.getElementById('booking-time-slot-modal');
                const startTimeInput = document.getElementById('booking-start-time');
                const endTimeInput = document.getElementById('booking-end-time');
                const notesField = document.getElementById('booking-notes');
                
                if (!startTimeInput || !startTimeInput.value || !endTimeInput || !endTimeInput.value) {
                    alert("Please select a valid time range");
                    return;
                }
                
                try {
                    // Wait for Firebase objects to be available
                    if (!window.BabysitBuddy || !window.BabysitBuddy.auth) {
                        console.log("Waiting for Firebase initialization...");
                        await new Promise(resolve => {
                            const checkInterval = setInterval(() => {
                                if (window.BabysitBuddy && window.BabysitBuddy.auth) {
                                    clearInterval(checkInterval);
                                    resolve();
                                }
                            }, 100);
                        });
                    }
                    
                    const auth = window.BabysitBuddy.auth;
                    const db = window.BabysitBuddy.db;
                    const user = auth.currentUser;
                    
                    if (!user) {
                        throw new Error("User not authenticated");
                    }
                    
                    if (!window.currentBookingSitter) {
                        throw new Error("No sitter selected for booking");
                    }
                    
                    console.log("Creating booking with sitter:", window.currentBookingSitter);
                    
                    const bookingData = {
                        parentId: user.uid,
                        sitterId: window.currentBookingSitter.id,
                        date: window.currentBookingDate,
                        timeSlot: {
                            start: startTimeInput.value,
                            end: endTimeInput.value
                        },
                        notes: notesField.value.trim(),
                        status: 'pending',
                        createdAt: window.BabysitBuddy.serverTimestamp()
                    };
                    
                    console.log("Booking data:", bookingData);
                    await window.BabysitBuddy.addDoc(
                        window.BabysitBuddy.collection(db, "bookings"), 
                        bookingData
                    );
                    
                    // Success handling
                    alert("Booking request sent successfully!");
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                    
                    // Reload data if functions available
                    if (typeof loadAvailableSitters === 'function') {
                        loadAvailableSitters(window.currentBookingDate);
                    }
                    
                    if (typeof loadUpcomingBookings === 'function') {
                        loadUpcomingBookings();
                    }
                } catch (error) {
                    console.error("Error in direct booking handler:", error);
                    alert("There was an error processing your booking: " + error.message);
                }
            }
        });
    });
</script>
</body>
</html>
